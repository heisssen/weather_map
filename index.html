<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå§Ô∏è WeatherMap Pro</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --bg-dark: #0f172a;
            --bg-card: rgba(15, 23, 42, 0.85);
            --text-light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.1);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            overflow: hidden;
        }

        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Canvas for Rain/Snow effects */
        #weatherCanvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* –©–æ–± –∫–ª—ñ–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –∫—Ä—ñ–∑—å canvas */
            z-index: 50;
        }

        /* UI Elements */
        .header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; align-items: center; gap: 20px;
            padding: 12px 24px; background: var(--bg-card);
            backdrop-filter: blur(20px); border-radius: 50px;
            border: 1px solid var(--glass); box-shadow: var(--shadow);
        }

        .logo { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        /* Controls overrides */
        .mapboxgl-ctrl-geocoder { background: transparent !important; box-shadow: none !important; min-width: 250px; }
        .mapboxgl-ctrl-geocoder--input { color: white !important; background: var(--glass) !important; border-radius: 20px !important; padding-left: 35px !important; }
        .mapboxgl-ctrl-geocoder--icon-search { fill: white !important; left: 10px !important; }

        .controls {
            position: fixed; left: 20px; top: 50%; transform: translateY(-50%);
            z-index: 100; display: flex; flex-direction: column; gap: 10px;
        }

        .control-btn {
            width: 45px; height: 45px; border: 1px solid var(--glass);
            border-radius: 12px; background: var(--bg-card); color: white;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .control-btn:hover, .control-btn.active { background: var(--primary); transform: scale(1.1); }

        /* Extra Controls (Globe/Map) */
        .extra-controls {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            z-index: 100; display: flex; flex-direction: column; gap: 10px;
        }

        /* Weather Card */
        .weather-card {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
            z-index: 100; background: var(--bg-card); backdrop-filter: blur(20px);
            border-radius: 20px; border: 1px solid var(--glass); padding: 25px;
            min-width: 380px; transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: var(--shadow);
        }
        .weather-card.visible { transform: translateX(-50%) translateY(0); }

        .wc-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .wc-main { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .wc-temp { font-size: 3.5rem; font-weight: 700; line-height: 1; }
        .wc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; }
        .wc-item { background: var(--glass); padding: 8px; border-radius: 8px; }
        
        /* Forecast Mini-list */
        .forecast { display: flex; gap: 10px; overflow-x: auto; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--glass); }
        .f-item { min-width: 60px; text-align: center; padding: 5px; background: var(--glass); border-radius: 8px; }

        .loading { position: fixed; inset: 0; background: #0f172a; z-index: 1000; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <!-- Fullscreen Weather Effects -->
    <canvas id="weatherCanvas"></canvas>

    <div class="loading" id="loading"><div style="color:white; font-size:1.5rem;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    
    <div id="map"></div>

    <header class="header">
        <div class="logo"><span>üå§Ô∏è</span>WeatherMap</div>
        <div id="geocoder"></div>
    </header>

    <!-- Layer Controls -->
    <div class="controls">
        <button class="control-btn active" onclick="setLayer('temp_new', this)">üå°Ô∏è</button>
        <button class="control-btn" onclick="setLayer('clouds_new', this)">‚òÅÔ∏è</button>
        <button class="control-btn" onclick="setLayer('precipitation_new', this)">üåßÔ∏è</button>
        <button class="control-btn" onclick="setLayer('wind_new', this)">üí®</button>
    </div>

    <!-- View Controls -->
    <div class="extra-controls">
        <button class="control-btn" id="globeBtn" onclick="toggleGlobe()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –ì–ª–æ–±—É—Å/–ú–∞–ø–∞">üåç</button>
        <button class="control-btn" onclick="flyHome()" title="–ú–æ—è –ª–æ–∫–∞—Ü—ñ—è">üìç</button>
    </div>

    <div class="weather-card" id="card">
        <div class="wc-header">
            <div>
                <h2 id="city" style="margin:0;">-</h2>
                <small id="country" style="opacity:0.7;">-</small>
            </div>
            <button onclick="document.getElementById('card').classList.remove('visible')" style="background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;">‚úï</button>
        </div>
        <div class="wc-main">
            <div id="icon" style="font-size:4rem;">‚òÄÔ∏è</div>
            <div>
                <div class="wc-temp" id="temp">0¬∞</div>
                <div id="desc" style="text-transform:capitalize; opacity:0.8;">-</div>
            </div>
        </div>
        <div class="wc-grid">
            <div class="wc-item"><div id="hum" style="font-weight:bold;">-</div><small>–í–æ–ª–æ–≥</small></div>
            <div class="wc-item"><div id="wind" style="font-weight:bold;">-</div><small>–í—ñ—Ç–µ—Ä</small></div>
            <div class="wc-item"><div id="press" style="font-weight:bold;">-</div><small>–¢–∏—Å–∫</small></div>
            <div class="wc-item"><div id="feels" style="font-weight:bold;">-</div><small>–í—ñ–¥—á—É—Ç</small></div>
        </div>
        <div class="forecast" id="forecast"></div>
    </div>

    <script>
        // ==================================================
        // üîë –í–°–¢–ê–í–¢–ï –ö–õ–Æ–ß–Ü –¢–£–¢
        // ==================================================
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiaGVpc3NlbiIsImEiOiJjbWl0eGIyMHAwYWNrM2RzOGVnOGVyZnFmIn0.Px59SHwajQl0jgVAxzEmsA'; 
        const OPENWEATHER_KEY = 'd782c9950fa15d52bc08574a17b5cb07';

        mapboxgl.accessToken = MAPBOX_TOKEN;

        // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–ø–∏ (–û–¥—Ä–∞–∑—É –ì–ª–æ–±—É—Å) ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [31.1656, 48.3794],
            zoom: 3,
            projection: 'globe' // –ü–æ—á–∏–Ω–∞—î–º–æ –∑ –≥–ª–æ–±—É—Å–∞
        });

        let isGlobe = true;
        let currentMarker = null;
        let weatherSystem = null; // –î–ª—è –µ—Ñ–µ–∫—Ç—ñ–≤ –¥–æ—â—É/—Å–Ω—ñ–≥—É

        // --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ---
        map.on('load', () => {
            document.getElementById('loading').classList.add('hidden');
            
            // 1. –î–æ–¥–∞—î–º–æ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É (–ó—ñ—Ä–∫–∏ —ñ —Ç—É–º–∞–Ω)
            map.setFog({
                'color': 'rgb(186, 210, 235)',
                'high-color': 'rgb(36, 92, 223)',
                'horizon-blend': 0.02,
                'space-color': 'rgb(11, 11, 25)',
                'star-intensity': 0.6
            });

            // 2. –î–æ–¥–∞—î–º–æ 3D –±—É–¥—ñ–≤–ª—ñ
            add3DBuildings();

            // 3. –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —à–∞—Ä –ø–æ–≥–æ–¥–∏
            addWeatherLayer('temp_new');

            // Geocoder
            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                marker: false,
                placeholder: '–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞...'
            });
            document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
            
            geocoder.on('result', (e) => {
                const [lon, lat] = e.result.center;
                handleLocationSelect(lat, lon);
            });
        });

        map.on('click', (e) => {
            handleLocationSelect(e.lngLat.lat, e.lngLat.lng);
        });

        // --- –õ–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É –ª–æ–∫–∞—Ü—ñ—ó ---
        function handleLocationSelect(lat, lon) {
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ–ª—å–æ—Ç—É
            map.flyTo({ center: [lon, lat], zoom: 10, speed: 1.5 });
            
            // –ú–∞—Ä–∫–µ—Ä
            if (currentMarker) currentMarker.remove();
            currentMarker = new mapboxgl.Marker({ color: '#6366f1' }).setLngLat([lon, lat]).addTo(map);

            // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≥–æ–¥–∏
            fetchWeather(lat, lon);
        }

        // --- 3D –ë—É–¥—ñ–≤–ª—ñ ---
        function add3DBuildings() {
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;

            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 14, // –ó'—è–≤–ª—è—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            }, labelLayerId);
        }

        // --- –ü–µ—Ä–µ–º–∏–∫–∞—á –ì–ª–æ–±—É—Å / –ú–∞–ø–∞ ---
        function toggleGlobe() {
            isGlobe = !isGlobe;
            const btn = document.getElementById('globeBtn');
            
            if (isGlobe) {
                map.setProjection('globe');
                btn.innerText = 'üåç';
                btn.title = "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ –ø–ª–æ—Å–∫—É –º–∞–ø—É";
            } else {
                map.setProjection('mercator'); // –ü–ª–æ—Å–∫–∞ –ø—Ä–æ–µ–∫—Ü—ñ—è –ú–µ—Ä–∫–∞—Ç–æ—Ä–∞
                btn.innerText = 'üó∫Ô∏è';
                btn.title = "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ –≥–ª–æ–±—É—Å";
            }
        }

        function flyHome() {
             if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    handleLocationSelect(pos.coords.latitude, pos.coords.longitude);
                });
            }
        }

        // --- –®–∞—Ä–∏ –ø–æ–≥–æ–¥–∏ ---
        function setLayer(layer, btn) {
            document.querySelectorAll('.controls .control-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            addWeatherLayer(layer);
        }

        function addWeatherLayer(layer) {
            const id = 'weather-layer';
            if (map.getLayer(id)) map.removeLayer(id);
            if (map.getSource('weather-source')) map.removeSource('weather-source');

            map.addSource('weather-source', {
                type: 'raster',
                tiles: [`https://tile.openweathermap.org/map/${layer}/{z}/{x}/{y}.png?appid=${OPENWEATHER_KEY}`],
                tileSize: 256
            });

            map.addLayer({
                id: id, type: 'raster', source: 'weather-source',
                paint: { 'raster-opacity': 0.7 }
            });
        }

        // --- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
        async function fetchWeather(lat, lon) {
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=uk&appid=${OPENWEATHER_KEY}`;
                const fUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=uk&appid=${OPENWEATHER_KEY}`;
                
                const [res, fRes] = await Promise.all([fetch(url), fetch(fUrl)]);
                const data = await res.json();
                const forecast = await fRes.json();

                displayWeather(data, forecast);
                updateWeatherEffects(data.weather[0].main); // –ó–∞–ø—É—Å–∫ –∞–Ω—ñ–º–∞—Ü—ñ—ó –¥–æ—â—É/—Å–Ω—ñ–≥—É
            } catch (e) {
                console.error(e);
            }
        }

        function displayWeather(data, forecast) {
            document.getElementById('city').innerText = data.name;
            document.getElementById('country').innerText = data.sys.country;
            document.getElementById('temp').innerText = Math.round(data.main.temp) + '¬∞';
            document.getElementById('desc').innerText = data.weather[0].description;
            document.getElementById('hum').innerText = data.main.humidity + '%';
            document.getElementById('wind').innerText = data.wind.speed;
            document.getElementById('press').innerText = data.main.pressure;
            document.getElementById('feels').innerText = Math.round(data.main.feels_like) + '¬∞';

            const icons = { '01': '‚òÄÔ∏è', '02': '‚õÖ', '03': '‚òÅÔ∏è', '04': '‚òÅÔ∏è', '09': 'üåßÔ∏è', '10': 'üå¶Ô∏è', '11': '‚õàÔ∏è', '13': '‚ùÑÔ∏è', '50': 'üå´Ô∏è' };
            document.getElementById('icon').innerText = icons[data.weather[0].icon.slice(0,2)] || 'üå§Ô∏è';

            // –ü—Ä–æ–≥–Ω–æ–∑
            const fDiv = document.getElementById('forecast');
            fDiv.innerHTML = '';
            forecast.list.slice(0, 8).forEach(item => {
                const d = new Date(item.dt * 1000);
                fDiv.innerHTML += `
                    <div class="f-item">
                        <div style="font-size:0.8rem">${d.getHours()}:00</div>
                        <div style="font-size:1.2rem">${icons[item.weather[0].icon.slice(0,2)] || 'üå§Ô∏è'}</div>
                        <strong>${Math.round(item.main.temp)}¬∞</strong>
                    </div>
                `;
            });

            document.getElementById('card').classList.add('visible');
        }

        // ==================================================
        // üåßÔ∏è CANVAS WEATHER EFFECTS (Rain/Snow Animation)
        // ==================================================
        const canvas = document.getElementById('weatherCanvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function updateWeatherEffects(weatherMain) {
            // –°–∫–∏–¥–∞–Ω–Ω—è –µ—Ñ–µ–∫—Ç—ñ–≤
            if (animationId) cancelAnimationFrame(animationId);
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const type = weatherMain.toLowerCase();
            
            // –Ø–∫—â–æ –¥–æ—â –∞–±–æ –º—Ä—è–∫–∞
            if (type.includes('rain') || type.includes('drizzle')) {
                initParticles('rain');
                animateParticles('rain');
            } 
            // –Ø–∫—â–æ —Å–Ω—ñ–≥
            else if (type.includes('snow')) {
                initParticles('snow');
                animateParticles('snow');
            }
        }

        function initParticles(type) {
            const count = 150; // –ö—ñ–ª—å–∫—ñ—Å—Ç—å —á–∞—Å—Ç–∏–Ω–æ–∫
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    speedY: type === 'rain' ? Math.random() * 15 + 10 : Math.random() * 3 + 1,
                    speedX: type === 'rain' ? 0 : Math.random() * 2 - 1,
                    length: type === 'rain' ? Math.random() * 20 + 10 : Math.random() * 3 + 2,
                    opacity: Math.random() * 0.5 + 0.1
                });
            }
        }

        function animateParticles(type) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'rgba(174, 194, 224, 0.5)';
            ctx.lineWidth = 1;

            particles.forEach(p => {
                if (type === 'rain') {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x, p.y + p.length);
                    ctx.stroke();
                } else {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.length, 0, Math.PI * 2);
                    ctx.fill();
                }

                p.y += p.speedY;
                p.x += p.speedX;

                if (p.y > canvas.height) {
                    p.y = -20;
                    p.x = Math.random() * canvas.width;
                }
            });

            animationId = requestAnimationFrame(() => animateParticles(type));
        }
    </script>
</body>
</html>
