<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteo Portal Ultimate v3.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Manrope', sans-serif; 
            background-color: #0f1115; 
            color: #e2e8f0; 
        }
        
        /* Glass Panel Styling */
        .panel {
            background: #1a1d24;
            border: 1px solid #2d3342;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Full Screen Overlay Transitions */
        .overlay {
            opacity: 0; pointer-events: none; transition: all 0.3s ease-in-out;
            transform: translateY(20px);
        }
        .overlay.active {
            opacity: 1; pointer-events: all; transform: translateY(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f1115; }
        ::-webkit-scrollbar-thumb { background: #3f465a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Table */
        .hourly-table th { 
            text-align: left; padding: 12px 16px; color: #94a3b8; font-size: 0.75rem; 
            text-transform: uppercase; font-weight: 600; background: #1a1d24; 
            position: sticky; left: 0; z-index: 10;
        }
        .hourly-table td { 
            padding: 12px 8px; text-align: center; border-right: 1px solid #2d3342; min-width: 70px; 
        }
        .hourly-table tr:nth-child(even) { background: #20242e; }
        .hourly-table tr:hover { background: #2d3342; }

        /* Custom Inputs */
        .search-input:focus-within { box-shadow: 0 0 0 2px #3b82f6; border-color: #3b82f6; }
    </style>
</head>

<body class="min-h-screen flex flex-col lg:flex-row overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-full lg:w-[360px] bg-[#1a1d24] border-r border-[#2d3342] flex flex-col h-screen relative z-20 shrink-0 overflow-y-auto">
        
        <div class="p-6 border-b border-[#2d3342] sticky top-0 bg-[#1a1d24] z-30 space-y-6">
            
            <!-- Big Search Button -->
            <button onclick="openSearchHub()" class="w-full text-left group">
                <div class="flex items-center gap-3 p-3 rounded-xl bg-[#0f1115] border border-[#2d3342] group-hover:border-blue-500/50 transition shadow-inner">
                    <i data-lucide="search" class="w-5 h-5 text-gray-500 group-hover:text-blue-400 transition"></i>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-gray-200">–ó–Ω–∞–π—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é...</span>
                        <span class="text-[10px] text-gray-500">–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞</span>
                    </div>
                    <div class="ml-auto bg-[#2d3342] px-2 py-1 rounded text-[10px] text-gray-400 font-mono">CMD+K</div>
                </div>
            </button>

            <div class="mt-4">
                <div class="flex items-center gap-2 mb-1">
                    <img id="current-flag" src="" class="w-5 h-auto rounded-sm shadow-sm" alt="flag">
                    <h1 id="city-name" class="text-3xl font-bold text-white tracking-tight truncate">–ö–∏—ó–≤</h1>
                </div>
                <p id="date-display" class="text-sm text-gray-400 font-medium">...</p>
            </div>
        </div>

        <div class="p-6 flex flex-col items-center flex-grow">
            <div id="main-icon" class="w-52 h-52 -my-2 drop-shadow-2xl filter saturate-110"></div>
            
            <div class="flex flex-col items-center">
                <span id="main-temp" class="text-8xl font-bold text-white tracking-tighter ml-2 bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-400">--</span>
                <span id="weather-desc" class="text-sm text-gray-300 font-medium capitalize mt-2 bg-[#2d3342] px-4 py-1.5 rounded-full border border-[#3f465a]">--</span>
            </div>

            <div class="grid grid-cols-2 gap-3 w-full mt-8">
                <div class="panel p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">–í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è</span>
                    <span class="text-xl font-bold text-white" id="feels-like">--</span>
                </div>
                <div class="panel p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">UV –Ü–Ω–¥–µ–∫—Å</span>
                    <span class="text-xl font-bold text-white" id="uv-index">--</span>
                </div>
                <div class="panel p-4 rounded-2xl flex flex-col items-center justify-center gap-1 col-span-2">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–í—ñ—Ç–µ—Ä</span>
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-[#2d3342] rounded-full"><i data-lucide="wind" class="w-5 h-5 text-blue-400"></i></div>
                        <span class="text-2xl font-bold text-white"><span id="wind-speed">--</span> <span class="text-sm text-gray-500 font-normal">–º/—Å</span></span>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-y-auto bg-[#0f1115] relative scroll-smooth">
        
        <div class="p-6 border-b border-[#2d3342] bg-[#1a1d24] flex items-center justify-between sticky top-0 z-10">
             <div class="flex items-center gap-2 text-gray-400">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                <span class="text-sm font-medium">Dashboard v3.0</span>
             </div>
             <button onclick="locateUser()" class="flex items-center gap-2 px-4 py-2 bg-[#2d3342] hover:bg-[#3f465a] rounded-lg border border-[#3f465a] text-xs font-bold text-white uppercase tracking-wide transition">
                 <i data-lucide="crosshair" class="w-4 h-4"></i> –õ–æ–∫–∞—Ü—ñ—è
             </button>
        </div>

        <div class="p-4 md:p-8 max-w-7xl mx-auto w-full space-y-6">

            <div class="panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-[#2d3342] flex items-center gap-3 bg-[#1f232d]/50">
                    <div class="bg-blue-500/10 p-1.5 rounded text-blue-400"><i data-lucide="clock" class="w-4 h-4"></i></div>
                    <h3 class="font-bold text-white text-sm uppercase tracking-wide">–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full hourly-table whitespace-nowrap">
                        <tbody id="hourly-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="panel rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-green-500/10 p-1.5 rounded text-green-400"><i data-lucide="activity" class="w-4 h-4"></i></div>
                    <h3 class="font-bold text-white text-sm uppercase tracking-wide">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∏–π —Ç—Ä–µ–Ω–¥</h3>
                </div>
                <div class="h-[250px] w-full"><canvas id="tempChart"></canvas></div>
            </div>

            <div>
                <div class="flex items-center gap-3 mb-4 px-1">
                    <div class="bg-purple-500/10 p-1.5 rounded text-purple-400"><i data-lucide="calendar-days" class="w-4 h-4"></i></div>
                    <h3 class="font-bold text-white text-sm uppercase tracking-wide">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 14 –¥–Ω—ñ–≤</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="daily-grid"></div>
            </div>
        </div>
    </main>

    <!-- FULL SCREEN SEARCH HUB -->
    <div id="search-hub" class="fixed inset-0 z-50 overlay bg-[#0f1115]/95 backdrop-blur-xl flex flex-col">
        
        <!-- Header -->
        <div class="p-4 md:p-8 max-w-5xl mx-auto w-full flex flex-col gap-6">
            <div class="flex justify-end">
                <button onclick="closeSearchHub()" class="p-2 rounded-full hover:bg-[#2d3342] text-gray-400 transition">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            
            <div class="relative search-input group rounded-2xl bg-[#1a1d24] border border-[#2d3342] transition">
                <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-500"></i>
                <input type="text" id="hub-input" 
                    class="w-full bg-transparent p-6 pl-16 text-xl md:text-2xl text-white placeholder-gray-600 focus:outline-none font-bold" 
                    placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ (–Ω–∞–ø—Ä. –õ–æ–Ω–¥–æ–Ω, –ö–∏—ó–≤)..."
                    onkeyup="handleHubSearch(this.value)">
                <div class="absolute right-6 top-1/2 -translate-y-1/2 hidden md:block">
                     <span class="text-xs bg-[#2d3342] px-2 py-1 rounded text-gray-400 border border-[#3f465a]">ESC to close</span>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-grow overflow-y-auto px-4 md:px-8 pb-12">
            <div class="max-w-5xl mx-auto">
                
                <!-- Category Tabs (Visible when NOT searching) -->
                <div id="hub-categories" class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    <button onclick="filterCatalog('ukraine')" class="px-5 py-2.5 rounded-xl bg-[#2d3342] hover:bg-[#3b82f6] text-white text-sm font-bold border border-[#3f465a] transition whitespace-nowrap">üá∫üá¶ –£–∫—Ä–∞—ó–Ω–∞</button>
                    <button onclick="filterCatalog('europe')" class="px-5 py-2.5 rounded-xl bg-[#1a1d24] hover:bg-[#2d3342] text-gray-400 hover:text-white text-sm font-bold border border-[#2d3342] transition whitespace-nowrap">üá™üá∫ –Ñ–≤—Ä–æ–ø–∞</button>
                    <button onclick="filterCatalog('world')" class="px-5 py-2.5 rounded-xl bg-[#1a1d24] hover:bg-[#2d3342] text-gray-400 hover:text-white text-sm font-bold border border-[#2d3342] transition whitespace-nowrap">üåé –°–≤—ñ—Ç</button>
                </div>

                <!-- Status Text -->
                <h3 id="hub-status" class="text-gray-500 text-sm font-bold uppercase tracking-widest mb-4">–ü–æ–ø—É–ª—è—Ä–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó</h3>

                <!-- Results Grid -->
                <div id="hub-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Cards Injected Here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ICONS & CONFIG ---
        const Icons = {
            sun: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><circle cx="32" cy="32" r="14" fill="#facc15" stroke="#eab308" stroke-width="2"/><path d="M32 4V10M32 54V60M4 32H10M54 32H60M12.2 12.2L16.4 16.4M47.6 47.6L51.8 51.8M12.2 51.8L16.4 47.6M47.6 16.4L51.8 12.2" stroke="#facc15" stroke-width="3" stroke-linecap="round"/></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M42 22A18 18 0 1 1 20 44A14 14 0 0 0 42 22Z" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1.5"/></svg>`,
            partly: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><circle cx="24" cy="24" r="10" fill="#facc15"/><path d="M18 44A8 8 0 0 1 26 30A12 12 0 0 1 48 38A8 8 0 0 1 42 52H24A8 8 0 0 1 18 44" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/></svg>`,
            cloud: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M16 42A10 10 0 0 1 26 24A14 14 0 0 1 50 32A10 10 0 0 1 42 50H22A10 10 0 0 1 16 42" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1.5"/></svg>`,
            rain: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M16 36A10 10 0 0 1 26 18A14 14 0 0 1 50 26A10 10 0 0 1 42 44H22A10 10 0 0 1 16 36" fill="#94a3b8"/><path d="M24 48L22 56M32 48L30 56M40 48L38 56" stroke="#3b82f6" stroke-width="3" stroke-linecap="round"/></svg>`,
            snow: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M16 36A10 10 0 0 1 26 18A14 14 0 0 1 50 26A10 10 0 0 1 42 44H22A10 10 0 0 1 16 36" fill="#cbd5e1"/><g fill="#fff"><circle cx="24" cy="52" r="2"/><circle cx="34" cy="56" r="2"/><circle cx="44" cy="50" r="2"/></g></svg>`,
            storm: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M16 36A10 10 0 0 1 26 18A14 14 0 0 1 50 26A10 10 0 0 1 42 44H22A10 10 0 0 1 16 36" fill="#64748b"/><path d="M34 40L26 50H32L30 60" stroke="#facc15" stroke-width="3" fill="none" stroke-linejoin="round"/></svg>`,
            fog: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="100%" height="100%"><path d="M14 42H50M18 50H46M16 34H48" stroke="#94a3b8" stroke-width="3" stroke-linecap="round"/></svg>`
        };
        const weatherDesc = { 0: "–Ø—Å–Ω–æ", 1: "–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ", 2: "–•–º–∞—Ä–Ω–æ", 3: "–ü–æ—Ö–º—É—Ä–æ", 45: "–¢—É–º–∞–Ω", 51: "–ú—Ä—è–∫–∞", 61: "–î–æ—â", 63: "–î–æ—â", 71: "–°–Ω—ñ–≥", 95: "–ì—Ä–æ–∑–∞" };

        function getIcon(code, isDay = 1) {
            if (code === 0) return isDay ? Icons.sun : Icons.moon;
            if (code <= 2) return Icons.partly;
            if (code === 3) return Icons.cloud;
            if (code >= 45 && code <= 48) return Icons.fog;
            if (code >= 51 && code <= 67) return Icons.rain;
            if (code >= 71 && code <= 86) return Icons.snow;
            if (code >= 95) return Icons.storm;
            return Icons.cloud;
        }

        // --- CATALOG DATA (Expanded with Country Codes) ---
        const CATALOG = {
            ukraine: [
                {name: "–ö–∏—ó–≤", code: "ua", lat: 50.45, lon: 30.52},
                {name: "–õ—å–≤—ñ–≤", code: "ua", lat: 49.84, lon: 24.03},
                {name: "–•–∞—Ä–∫—ñ–≤", code: "ua", lat: 49.99, lon: 36.23},
                {name: "–û–¥–µ—Å–∞", code: "ua", lat: 46.48, lon: 30.72},
                {name: "–î–Ω—ñ–ø—Ä–æ", code: "ua", lat: 48.46, lon: 35.04},
                {name: "–ó–∞–ø–æ—Ä—ñ–∂–∂—è", code: "ua", lat: 47.84, lon: 35.14},
                {name: "–í—ñ–Ω–Ω–∏—Ü—è", code: "ua", lat: 49.23, lon: 28.47},
                {name: "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫", code: "ua", lat: 48.92, lon: 24.71},
                {name: "–£–∂–≥–æ—Ä–æ–¥", code: "ua", lat: 48.62, lon: 22.29},
                {name: "–Ø–ª—Ç–∞", code: "ua", lat: 44.49, lon: 34.16}
            ],
            europe: [
                {name: "–í–∞—Ä—à–∞–≤–∞", code: "pl", lat: 52.23, lon: 21.01},
                {name: "–õ–æ–Ω–¥–æ–Ω", code: "gb", lat: 51.51, lon: -0.13},
                {name: "–ü–∞—Ä–∏–∂", code: "fr", lat: 48.85, lon: 2.35},
                {name: "–ë–µ—Ä–ª—ñ–Ω", code: "de", lat: 52.52, lon: 13.41},
                {name: "–†–∏–º", code: "it", lat: 41.89, lon: 12.51},
                {name: "–ú–∞–¥—Ä–∏–¥", code: "es", lat: 40.41, lon: -3.70},
                {name: "–ê–º—Å—Ç–µ—Ä–¥–∞–º", code: "nl", lat: 52.37, lon: 4.89},
                {name: "–ü—Ä–∞–≥–∞", code: "cz", lat: 50.08, lon: 14.42},
                {name: "–í—ñ–¥–µ–Ω—å", code: "at", lat: 48.21, lon: 16.37},
                {name: "–û—Å–ª–æ", code: "no", lat: 59.91, lon: 10.75}
            ],
            world: [
                {name: "–ù—å—é-–ô–æ—Ä–∫", code: "us", lat: 40.71, lon: -74.01},
                {name: "–¢–æ–∫—ñ–æ", code: "jp", lat: 35.69, lon: 139.69},
                {name: "–î—É–±–∞–π", code: "ae", lat: 25.20, lon: 55.27},
                {name: "–°—ñ–¥–Ω–µ–π", code: "au", lat: -33.87, lon: 151.21},
                {name: "–¢–æ—Ä–æ–Ω—Ç–æ", code: "ca", lat: 43.70, lon: -79.42},
                {name: "–°—ñ–Ω–≥–∞–ø—É—Ä", code: "sg", lat: 1.35, lon: 103.82}
            ]
        };

        let state = { lat: 50.45, lon: 30.52, name: "–ö–∏—ó–≤", code: "ua" };
        let chartInstance = null;
        let searchDebounce;

        // --- APP LOGIC ---

        async function init() {
            const saved = localStorage.getItem('meteo_v3_state');
            if (saved) state = JSON.parse(saved);
            updateDate();
            await fetchData();
            
            // Key binding for search
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    openSearchHub();
                }
                if (e.key === 'Escape') closeSearchHub();
            });
        }

        async function fetchData() {
            try {
                // Fetch Weather
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&current=temperature_2m,apparent_temperature,is_day,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,precipitation,precipitation_probability,wind_speed_10m,wind_direction_10m,wind_gusts_10m,is_day&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_sum,uv_index_max&timezone=auto&forecast_days=14`;
                const res = await fetch(url);
                const data = await res.json();
                render(data);
            } catch (e) { console.error("API Error", e); }
        }

        function render(data) {
            const cur = data.current;
            
            document.getElementById('city-name').innerText = state.name;
            document.getElementById('current-flag').src = `https://flagcdn.com/48x36/${state.code.toLowerCase()}.png`;
            
            document.getElementById('main-temp').innerText = Math.round(cur.temperature_2m) + "¬∞";
            document.getElementById('weather-desc').innerText = weatherDesc[cur.weather_code] || "–ù–µ–≤—ñ–¥–æ–º–æ";
            document.getElementById('main-icon').innerHTML = getIcon(cur.weather_code, cur.is_day);
            
            document.getElementById('feels-like').innerText = Math.round(cur.apparent_temperature) + "¬∞";
            document.getElementById('uv-index').innerText = data.daily.uv_index_max[0];
            document.getElementById('wind-speed').innerText = (cur.wind_speed_10m / 3.6).toFixed(1);

            renderTable(data.hourly);
            renderChart(data.hourly);
            renderCards(data.daily);
            lucide.createIcons();
        }

        // --- RENDERERS ---
        function renderTable(hourly) {
            const tbody = document.getElementById('hourly-table-body');
            tbody.innerHTML = `
                <tr><th class="sticky left-0 bg-[#1a1d24] z-10">–ß–∞—Å</th>${hourly.time.slice(0, 24).map(t => `<td class="text-gray-400 font-mono">${t.split('T')[1].slice(0, 5)}</td>`).join('')}</tr>
                <tr><th class="sticky left-0 bg-[#1a1d24] z-10"></th>${hourly.weather_code.slice(0, 24).map((c, i) => `<td class="py-2"><div class="w-8 h-8 mx-auto">${getIcon(c, hourly.is_day[i])}</div></td>`).join('')}</tr>
                <tr><th class="sticky left-0 bg-[#1a1d24] z-10">–¢–µ–º–ø</th>${hourly.temperature_2m.slice(0, 24).map(t => `<td class="font-bold text-lg ${t>0?'text-green-400':t<0?'text-blue-300':'text-white'}">${t>0?'+'+Math.round(t):Math.round(t)}¬∞</td>`).join('')}</tr>
                <tr><th class="sticky left-0 bg-[#1a1d24] z-10">–í—ñ—Ç–µ—Ä</th>${hourly.wind_speed_10m.slice(0, 24).map((s, i) => `<td><div class="flex flex-col items-center"><i data-lucide="arrow-up" style="transform:rotate(${hourly.wind_direction_10m[i]}deg)" class="w-3 h-3 text-gray-500 mb-1"></i><span class="text-xs text-gray-300">${(s/3.6).toFixed(1)}</span></div></td>`).join('')}</tr>
                <tr><th class="sticky left-0 bg-[#1a1d24] z-10">–û–ø–∞–¥–∏</th>${hourly.precipitation.slice(0, 24).map(p => `<td>${p>0 ? `<span class="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 text-xs font-bold">${p}</span>` : '<span class="text-gray-700">-</span>'}</td>`).join('')}</tr>
            `;
        }

        function renderChart(hourly) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourly.time.slice(0, 24).map(t => t.split('T')[1].slice(0, 5)),
                    datasets: [{
                        data: hourly.temperature_2m.slice(0, 24),
                        borderColor: '#3b82f6',
                        backgroundColor: ctx.createLinearGradient(0, 0, 0, 300),
                        borderWidth: 3,
                        pointBackgroundColor: '#1a1d26',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b' } },
                        y: { display: false }
                    }
                }
            });
            // Fix gradient bug
            chartInstance.data.datasets[0].backgroundColor.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            chartInstance.data.datasets[0].backgroundColor.addColorStop(1, 'rgba(59, 130, 246, 0)');
            chartInstance.update();
        }

        function renderCards(daily) {
            const grid = document.getElementById('daily-grid');
            grid.innerHTML = daily.time.map((t, i) => {
                const date = new Date(t);
                const dayName = i===0 ? '–°—å–æ–≥–æ–¥–Ω—ñ' : date.toLocaleDateString('uk-UA', {weekday:'long'});
                const rain = daily.precipitation_sum[i];
                return `
                    <div class="panel p-4 rounded-xl flex items-center justify-between hover:bg-[#2d3342] transition">
                        <div class="flex flex-col w-28">
                            <span class="font-bold text-gray-200 text-sm capitalize">${dayName}</span>
                            <span class="text-xs text-gray-500">${date.toLocaleDateString('uk-UA', {day:'numeric', month:'short'})}</span>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center">${getIcon(daily.weather_code[i], 1)}</div>
                        <div class="flex items-center gap-2 w-36 justify-end">
                            ${rain > 0 ? `<div class="flex items-center gap-1 bg-blue-500/10 px-2 py-0.5 rounded-lg text-blue-400 text-xs font-bold"><i data-lucide="droplets" class="w-3 h-3"></i>${Math.round(rain)}–º–º</div>` : ''}
                            <div class="text-right flex gap-2 font-mono text-sm"><span class="text-gray-500">${Math.round(daily.temperature_2m_min[i])}¬∞</span><span class="text-white font-bold">${Math.round(daily.temperature_2m_max[i])}¬∞</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- SEARCH HUB LOGIC ---

        function openSearchHub() {
            document.getElementById('search-hub').classList.add('active');
            document.getElementById('hub-input').focus();
            filterCatalog('ukraine'); // Init with default catalog
        }

        function closeSearchHub() {
            document.getElementById('search-hub').classList.remove('active');
        }

        function filterCatalog(category) {
            // UI Update
            document.querySelectorAll('#hub-categories button').forEach(b => {
                b.classList.remove('bg-[#2d3342]', 'text-white');
                b.classList.add('bg-[#1a1d24]', 'text-gray-400');
            });
            event.target.classList.remove('bg-[#1a1d24]', 'text-gray-400');
            event.target.classList.add('bg-[#2d3342]', 'text-white');

            // Render
            document.getElementById('hub-status').innerText = "–ü–æ–ø—É–ª—è—Ä–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó";
            renderHubGrid(CATALOG[category].sort((a, b) => a.name.localeCompare(b.name, 'uk')));
        }

        function renderHubGrid(list) {
            const grid = document.getElementById('hub-grid');
            grid.innerHTML = list.map(city => `
                <button onclick='selectCity(${JSON.stringify(city)})' class="flex items-center gap-4 p-4 rounded-xl bg-[#1a1d24] border border-[#2d3342] hover:border-blue-500 hover:bg-[#20242e] transition group text-left w-full">
                    <img src="https://flagcdn.com/48x36/${city.code.toLowerCase()}.png" class="w-10 h-auto rounded shadow-sm opacity-80 group-hover:opacity-100 transition" alt="${city.code}">
                    <div class="flex flex-col">
                        <span class="text-lg font-bold text-gray-200 group-hover:text-white transition">${city.name}</span>
                        <span class="text-xs text-gray-500 uppercase tracking-wider font-bold">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: ${city.lat.toFixed(1)}, ${city.lon.toFixed(1)}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600 ml-auto group-hover:text-blue-400 transition"></i>
                </button>
            `).join('');
            lucide.createIcons();
        }

        async function handleHubSearch(val) {
            const cats = document.getElementById('hub-categories');
            const status = document.getElementById('hub-status');
            
            if (val.length < 2) {
                cats.classList.remove('hidden'); // Show tabs back
                status.innerText = "–ü–æ–ø—É–ª—è—Ä–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó";
                filterCatalog('ukraine'); // Reset to default
                return;
            }

            // Hide tabs while searching
            cats.classList.add('hidden');
            status.innerHTML = `<span class="animate-pulse">–ü–æ—à—É–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ—é –±–∞–∑–æ—é...</span>`;

            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(async() => {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=12&language=uk&format=json`);
                const data = await res.json();
                
                if (!data.results) {
                    status.innerText = "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
                    document.getElementById('hub-grid').innerHTML = '';
                    return;
                }

                status.innerText = `–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É: ${data.results.length}`;
                
                // Map API results to our format
                const formatted = data.results.map(item => ({
                    name: item.name,
                    code: item.country_code.toLowerCase(),
                    lat: item.latitude,
                    lon: item.longitude
                }));

                renderHubGrid(formatted);
            }, 300);
        }

        function selectCity(city) {
            state = city;
            localStorage.setItem('meteo_v3_state', JSON.stringify(state));
            closeSearchHub();
            fetchData();
        }
        
        function locateUser() {
             if(!navigator.geolocation) return alert('Geoloc not supported');
             navigator.geolocation.getCurrentPosition(async (pos) => {
                 const res = await fetch(`https://geocoding-api.open-meteo.com/v1/get?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&language=uk`);
                 const d = await res.json();
                 selectCity({name: d.name, code: d.country_code.toLowerCase(), lat: pos.coords.latitude, lon: pos.coords.longitude});
             });
        }

        function updateDate() {
            const d = new Date();
            const s = d.toLocaleDateString('uk-UA', {weekday:'long', day:'numeric', month:'long'});
            document.getElementById('date-display').innerText = s.charAt(0).toUpperCase() + s.slice(1);
        }

        init();
    </script>
</body>
</html>
