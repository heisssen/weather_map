<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meteo Portal v9.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#050505', card: 'rgba(20, 25, 35, 0.7)' },
                        light: { bg: '#f8fafc', card: 'rgba(255, 255, 255, 0.85)' }
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Manrope', sans-serif; 
            transition: background 0.4s ease, color 0.3s ease;
            margin: 0; padding: 0;
        }
        
        /* DARK THEME */
        body.dark { 
            background-color: #050505; 
            color: #e2e8f0; 
            background-image: radial-gradient(circle at 15% 15%, #1e293b 0%, #050505 45%);
        }
        .dark .glass {
            background: rgba(20, 25, 35, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        .dark .glass-input { background: #151515; border-color: rgba(255,255,255,0.1); color: #fff; }

        /* LIGHT THEME IMPROVED */
        body.light { 
            background-color: #f1f5f9; 
            color: #334155; 
            background-image: radial-gradient(circle at 10% 10%, #e0f2fe 0%, #f1f5f9 60%);
        }
        .light .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.15);
        }
        .light .glass-input { background: #fff; border-color: #cbd5e1; color: #0f172a; }
        
        /* UTILS */
        .compact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .compact-card { padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .dark::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .light::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }

        /* TABS */
        .tab-btn { transition: all 0.2s ease; white-space: nowrap; }
        .tab-btn.active { 
            background: #3b82f6 !important; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        
        .overlay { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .overlay.active { opacity: 1; pointer-events: all; }

        /* MOON */
        .moon-container { width: 120px; height: 120px; position: relative; margin: 0 auto; }
        .moon-base {
            width: 100%; height: 100%; border-radius: 50%;
            background: linear-gradient(135deg, #f5f5f5 0%, #d4d4d4 50%, #a3a3a3 100%);
            box-shadow: inset -8px -8px 20px rgba(0,0,0,0.3), 0 0 40px rgba(255,255,255,0.1);
            position: relative; overflow: hidden;
        }
        .moon-shadow { position: absolute; top: 0; height: 100%; background: #1a1a2e; transition: all 0.5s ease; }
        .moon-crater { position: absolute; border-radius: 50%; background: rgba(0,0,0,0.15); }
        
        .uv-scale { 
            height: 8px; border-radius: 4px; 
            background: linear-gradient(to right, #22c55e 0%, #eab308 25%, #f97316 50%, #ef4444 75%, #7c3aed 100%); 
        }
        
        .theme-toggle { transition: transform 0.3s ease; }
        .theme-toggle:hover { transform: rotate(180deg); }
        .local-time { font-variant-numeric: tabular-nums; }

        /* Typography overrides for themes */
        .dark .text-primary { color: #ffffff; }
        .light .text-primary { color: #0f172a; } /* Darker text for light mode */
        
        .dark .text-secondary { color: #94a3b8; }
        .light .text-secondary { color: #64748b; }

        .leader-line {
            flex-grow: 1;
            margin: 0 10px;
            border-bottom: 2px dotted;
            opacity: 0.3;
            transform: translateY(-4px);
        }
        .dark .leader-line { border-color: #fff; }
        .light .leader-line { border-color: #000; }
    </style>
</head>

<body class="dark min-h-screen flex flex-col lg:flex-row overflow-hidden text-sm md:text-base">

    <aside class="w-full lg:w-[320px] border-r border-white/10 flex flex-col h-auto lg:h-screen relative z-20 shrink-0 glass transition-all">
        <div class="p-5 border-b border-white/5">
            <div class="flex gap-2 mb-4">
                <button id="btn-search" class="flex-1 text-left group">
                    <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-transparent group-hover:border-blue-500/30 transition">
                        <i data-lucide="search" class="w-4 h-4 text-secondary group-hover:text-blue-500"></i>
                        <span class="text-sm font-bold text-secondary">–ü–æ—à—É–∫...</span>
                        <div class="ml-auto bg-white/10 px-1.5 py-0.5 rounded text-[10px] font-mono text-gray-500 hidden sm:block">‚åòK</div>
                    </div>
                </button>
                <button id="btn-theme" class="theme-toggle p-3 rounded-xl bg-white/5 hover:bg-white/10 transition border border-transparent" title="–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É">
                    <i data-lucide="sun" class="w-5 h-5 text-amber-500 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 text-blue-600 block dark:hidden"></i>
                </button>
            </div>
            
            <div class="flex items-center gap-3">
                <img id="flag" src="" class="w-8 h-6 rounded shadow opacity-90 object-cover" alt="–ü—Ä–∞–ø–æ—Ä">
                <div class="overflow-hidden flex-1">
                    <h1 id="city-name" class="text-xl font-black text-primary truncate">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
                    <p id="date-display" class="text-[10px] text-blue-500 font-bold uppercase tracking-wide">---</p>
                </div>
                <button id="btn-locate" class="p-2 rounded-lg bg-white/5 hover:bg-blue-500 hover:text-white transition group" title="–ú–æ—î –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è">
                    <i data-lucide="crosshair" class="w-4 h-4 text-secondary group-hover:text-white"></i>
                </button>
            </div>
        </div>

        <div class="p-5 flex flex-col items-center flex-grow lg:overflow-y-auto">
            <div id="main-icon" class="w-32 h-32 mb-2 drop-shadow-[0_0_25px_rgba(59,130,246,0.3)] transform hover:scale-105 transition duration-500"></div>
            
            <div class="flex flex-col items-center mb-6">
                <span id="main-temp" class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 dark:from-white dark:to-gray-400 light:from-slate-800 light:to-slate-500 tracking-tighter">--¬∞</span>
                <span id="weather-desc" class="text-xs font-bold text-blue-400 dark:text-blue-300 uppercase tracking-wide mt-1 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20">---</span>
            </div>

            <div class="glass w-full p-3 rounded-xl mb-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] text-secondary uppercase font-bold flex items-center gap-1">
                        <i data-lucide="sun" class="w-3 h-3"></i> UV –Ü–Ω–¥–µ–∫—Å
                    </span>
                    <span class="text-sm font-bold" id="uv-value">--</span>
                </div>
                <div class="uv-scale w-full relative">
                    <div class="absolute w-3 h-3 bg-white rounded-full border-2 border-gray-800 -top-0.5 transition-all shadow-lg" id="uv-marker" style="left: 0%"></div>
                </div>
                <p class="text-[10px] text-center mt-2 text-secondary" id="uv-text">---</p>
            </div>

            <div class="compact-grid w-full gap-2 mb-3">
                <div class="glass compact-card rounded-xl">
                    <span class="text-[10px] text-secondary uppercase font-bold">–í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è</span>
                    <span class="text-lg font-bold text-primary" id="feels-like">--¬∞</span>
                </div>
                <div class="glass compact-card rounded-xl">
                    <span class="text-[10px] text-secondary uppercase font-bold">–í–æ–ª–æ–≥—ñ—Å—Ç—å</span>
                    <span class="text-lg font-bold text-blue-500" id="humidity">--%</span>
                </div>
                <div class="glass compact-card rounded-xl">
                    <span class="text-[10px] text-secondary uppercase font-bold">–í—ñ—Ç–µ—Ä</span>
                    <span class="text-lg font-bold text-primary" id="wind">-- –º/—Å</span>
                </div>
                <div class="glass compact-card rounded-xl">
                    <span class="text-[10px] text-secondary uppercase font-bold">–¢–∏—Å–∫</span>
                    <span class="text-lg font-bold text-primary" id="pressure">-- –≥–ü–∞</span>
                </div>
            </div>

            <div class="glass w-full p-3 rounded-xl flex items-center justify-around">
                <div class="flex flex-col items-center">
                    <i data-lucide="sunrise" class="w-5 h-5 text-orange-400 mb-1"></i>
                    <span class="text-[10px] text-secondary uppercase">–°—Ö—ñ–¥</span>
                    <span id="sunrise" class="text-sm font-bold text-primary">--:--</span>
                </div>
                <div class="w-px h-10 bg-gray-500/20"></div>
                <div class="flex flex-col items-center">
                    <i data-lucide="sunset" class="w-5 h-5 text-purple-400 mb-1"></i>
                    <span class="text-[10px] text-secondary uppercase">–ó–∞—Ö—ñ–¥</span>
                    <span id="sunset" class="text-sm font-bold text-primary">--:--</span>
                </div>
            </div>
            
            <div class="mt-4 lg:mt-auto text-[9px] text-secondary font-mono opacity-50">Meteo Portal v9.1</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-transparent">
        <header class="p-4 md:p-6 border-b border-white/5 glass z-10 shrink-0">
            <nav class="overflow-x-auto pb-1 md:pb-0 -mx-4 px-4 md:mx-0 md:px-0">
                <div class="flex p-1 bg-gray-500/10 rounded-xl border border-white/5 w-max md:w-fit">
                    <button data-tab="overview" class="tab-btn active px-4 md:px-5 py-2.5 md:py-2 rounded-lg text-sm font-bold text-secondary flex items-center gap-2">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i>
                        <span>–ì–æ–ª–æ–≤–Ω–∞</span>
                    </button>
                    <button data-tab="air" class="tab-btn px-4 md:px-5 py-2.5 md:py-2 rounded-lg text-sm font-bold text-secondary flex items-center gap-2">
                        <i data-lucide="wind" class="w-4 h-4"></i>
                        <span>–ü–æ–≤—ñ—Ç—Ä—è</span>
                    </button>
                    <button data-tab="pollen" class="tab-btn px-4 md:px-5 py-2.5 md:py-2 rounded-lg text-sm font-bold text-secondary flex items-center gap-2">
                        <i data-lucide="flower-2" class="w-4 h-4"></i>
                        <span>–ü–∏–ª–æ–∫</span>
                    </button>
                    <button data-tab="astro" class="tab-btn px-4 md:px-5 py-2.5 md:py-2 rounded-lg text-sm font-bold text-secondary flex items-center gap-2">
                        <i data-lucide="moon-star" class="w-4 h-4"></i>
                        <span>–ê—Å—Ç—Ä–æ</span>
                    </button>
                </div>
            </nav>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-20 md:pb-8">
            
            <section id="tab-overview" class="tab-content active space-y-6">
                <div class="glass rounded-2xl p-4 md:p-6 fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                        <h3 class="font-bold text-primary text-lg flex items-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5 text-blue-500"></i>
                            –ü–æ–≥–æ–¥–∞ –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏
                        </h3>
                        <div class="flex gap-4 text-xs font-medium text-secondary">
                            <span class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-blue-500"></span> –¢–µ–º–ø.
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-blue-900/50 dark:bg-blue-900"></span> –û–ø–∞–¥–∏
                            </span>
                        </div>
                    </div>
                    <div class="h-[250px] md:h-[350px] w-full">
                        <canvas id="weatherChart"></canvas>
                    </div>
                </div>

                <div class="fade-in">
                    <h3 class="font-bold text-primary text-lg mb-4 ml-1">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 14 –¥–Ω—ñ–≤</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3" id="daily-grid"></div>
                </div>
            </section>

            <section id="tab-air" class="tab-content space-y-6">
                <div class="glass rounded-2xl p-6 md:p-8 relative overflow-hidden fade-in">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-60 h-60 md:w-80 md:h-80 blur-[80px] md:blur-[100px] rounded-full pointer-events-none transition-colors duration-500 opacity-60" id="aqi-glow"></div>
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <span class="text-xs font-bold text-secondary uppercase tracking-widest mb-2">–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è (CAQI)</span>
                        <span class="text-7xl md:text-8xl font-black text-primary tracking-tighter mb-2" id="aqi-value">--</span>
                        <span class="text-xl md:text-2xl font-bold px-6 py-2 rounded-full border backdrop-blur-md mb-4 shadow-lg" id="aqi-status">---</span>
                        <p class="text-secondary max-w-lg text-sm leading-relaxed" id="aqi-desc">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 fade-in">
                    <div class="glass p-5 rounded-xl border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="font-bold text-primary text-lg">PM2.5</h4></div>
                            <span class="text-2xl font-bold text-blue-500" id="pol-pm25">--</span>
                        </div>
                        <div class="h-2 bg-gray-500/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-500" id="pm25-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-xl border-l-4 border-indigo-500">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="font-bold text-primary text-lg">PM10</h4></div>
                            <span class="text-2xl font-bold text-indigo-500" id="pol-pm10">--</span>
                        </div>
                        <div class="h-2 bg-gray-500/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-indigo-400 to-indigo-600 transition-all duration-500" id="pm10-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-xl border-l-4 border-orange-500">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="font-bold text-primary text-lg">NO‚ÇÇ</h4></div>
                            <span class="text-2xl font-bold text-orange-500" id="pol-no2">--</span>
                        </div>
                        <div class="h-2 bg-gray-500/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-orange-400 to-orange-600 transition-all duration-500" id="no2-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-xl border-l-4 border-teal-500">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="font-bold text-primary text-lg">O‚ÇÉ</h4></div>
                            <span class="text-2xl font-bold text-teal-500" id="pol-o3">--</span>
                        </div>
                        <div class="h-2 bg-gray-500/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-teal-400 to-teal-600 transition-all duration-500" id="o3-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="glass rounded-2xl p-6 fade-in">
                    <h4 class="font-bold text-primary mb-4 flex items-center gap-2">
                        <i data-lucide="heart-pulse" class="w-5 h-5 text-red-400"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="health-recommendations"></div>
                </div>
            </section>

            <section id="tab-pollen" class="tab-content space-y-6">
                <div class="glass rounded-2xl p-6 md:p-8 fade-in">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                        <h3 class="font-bold text-primary text-xl flex items-center gap-2">
                            <i data-lucide="flower-2" class="w-6 h-6 text-pink-500"></i>
                            –†—ñ–≤–µ–Ω—å –ø–∏–ª–∫—É —Ç–∞ –∞–ª–µ—Ä–≥–µ–Ω—ñ–≤
                        </h3>
                        <span class="text-xs text-secondary bg-gray-500/10 px-3 py-1.5 rounded-full font-medium" id="pollen-date">---</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-3">
                            <div class="text-center mb-4">
                                <div class="text-4xl mb-2">üå≥</div>
                                <h4 class="font-bold text-primary">–î–µ—Ä–µ–≤–∞</h4>
                            </div>
                            <div id="group-trees" class="space-y-2">
                                </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="text-center mb-4">
                                <div class="text-4xl mb-2">üåæ</div>
                                <h4 class="font-bold text-primary">–¢—Ä–∞–≤–∏</h4>
                            </div>
                            <div id="group-grass" class="space-y-2">
                                </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="text-center mb-4">
                                <div class="text-4xl mb-2">üçÉ</div>
                                <h4 class="font-bold text-primary">–Ü–Ω—à–µ</h4>
                            </div>
                            <div id="group-other" class="space-y-2">
                                </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass rounded-2xl p-6 fade-in">
                    <h4 class="font-bold text-primary mb-4 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-green-500"></i>
                        –ü–æ—Ä–∞–¥–∏ –∞–ª–µ—Ä–≥—ñ–∫–∞–º
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="allergy-tips"></div>
                </div>
            </section>

            <section id="tab-astro" class="tab-content space-y-6">
                <div class="glass rounded-2xl p-6 fade-in">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-6 sm:gap-10">
                        <div class="text-center">
                            <span class="text-xs text-secondary uppercase font-bold block mb-1">–ß–∞—Å</span>
                            <span class="text-4xl md:text-5xl font-black text-primary local-time" id="local-time">--:--:--</span>
                        </div>
                        <div class="hidden sm:block w-px h-16 bg-gray-500/20"></div>
                        <div class="text-center">
                            <span class="text-xs text-secondary uppercase font-bold block mb-1">–°—Ç–∞—Ç—É—Å</span>
                            <span class="text-lg font-bold" id="day-night-status">---</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass rounded-2xl p-6 md:p-8 fade-in relative overflow-hidden min-h-[380px] flex flex-col">
                        <div class="absolute inset-x-0 bottom-0 h-1/2 transition-all duration-500" id="astro-gradient"></div>
                        <h3 class="text-sm font-bold text-secondary uppercase tracking-widest mb-6 relative z-10 flex items-center gap-2" id="astro-title">‚òÄÔ∏è –°–æ–Ω—Ü–µ</h3>
                        
                        <div class="relative w-full max-w-[280px] h-36 mx-auto mb-6 flex-shrink-0">
                            <svg viewBox="0 0 200 100" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                                <line x1="0" y1="95" x2="200" y2="95" stroke="currentColor" stroke-opacity="0.2" stroke-width="2"/>
                                <path d="M 10 95 Q 100 -20 190 95" fill="none" stroke="currentColor" stroke-opacity="0.1" stroke-width="2" stroke-dasharray="5,5"/>
                                <path id="arc-traveled" d="M 10 95 Q 100 -20 190 95" fill="none" stroke="url(#arcGradient)" stroke-width="3" stroke-linecap="round"/>
                                <circle id="celestial-glow" cx="100" cy="20" r="20" fill="rgba(251,191,36,0.2)">
                                    <animate attributeName="r" values="18;24;18" dur="3s" repeatCount="indefinite"/>
                                </circle>
                                <circle id="celestial-body" cx="100" cy="20" r="12" fill="#fbbf24"/>
                                <defs>
                                    <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" id="arc-color-start" style="stop-color:#f97316"/>
                                        <stop offset="50%" id="arc-color-mid" style="stop-color:#fbbf24"/>
                                        <stop offset="100%" id="arc-color-end" style="stop-color:#f97316"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 text-center mt-auto relative z-10">
                            <div>
                                <span class="text-[10px] text-secondary uppercase font-bold block" id="start-label">–°—Ö—ñ–¥</span>
                                <span class="text-lg font-bold" id="astro-start">--:--</span>
                            </div>
                            <div>
                                <span class="text-[10px] text-secondary uppercase font-bold block">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</span>
                                <span class="text-lg font-bold text-primary" id="arc-duration">-- –≥–æ–¥</span>
                            </div>
                            <div>
                                <span class="text-[10px] text-secondary uppercase font-bold block" id="end-label">–ó–∞—Ö—ñ–¥</span>
                                <span class="text-lg font-bold" id="astro-end">--:--</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 md:p-8 fade-in relative overflow-hidden min-h-[380px] flex flex-col items-center justify-center">
                        <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-indigo-500/10 to-transparent"></div>
                        <h3 class="text-sm font-bold text-secondary uppercase tracking-widest absolute top-6 left-6 flex items-center gap-2">üåô –ú—ñ—Å—è—Ü—å</h3>
                        
                        <div class="moon-container mb-6 relative z-10">
                            <div class="moon-base">
                                <div class="moon-crater" style="width: 22px;height:22px;top:18%;left:28%;"></div>
                                <div class="moon-crater" style="width:16px;height:16px;top:48%;left:58%;"></div>
                                <div class="moon-shadow" id="moon-shadow-el"></div>
                            </div>
                        </div>
                        
                        <span class="text-2xl font-bold text-primary mb-2 relative z-10 text-center" id="moon-phase-name">---</span>
                        <span class="text-sm text-purple-400 font-mono mb-1 relative z-10" id="moon-illumination">--%</span>
                        <span class="text-xs text-secondary relative z-10" id="moon-age">–î–µ–Ω—å --</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="search-modal" class="fixed inset-0 z-50 overlay flex flex-col items-center pt-16 md:pt-24 px-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-xl" id="search-backdrop"></div>
        <div class="relative z-10 w-full max-w-2xl flex flex-col gap-4">
            <div class="flex justify-between items-center text-secondary px-2">
                <span class="text-xs font-bold uppercase tracking-wide">–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞</span>
                <button id="btn-close-search" class="p-2 hover:bg-white/10 rounded-lg transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <input type="text" id="search-input" class="w-full glass-input border rounded-2xl p-5 text-lg font-semibold placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞..." autocomplete="off">
            <div id="search-results" class="grid grid-cols-1 gap-2 overflow-y-auto max-h-[50vh] rounded-xl"></div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // --- CONFIG & CONSTANTS ---
        const CONFIG = {
            weatherDescriptions: {
                0: "–Ø—Å–Ω–æ", 1: "–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ", 2: "–ú—ñ–Ω–ª–∏–≤–∞ —Ö–º–∞—Ä–Ω—ñ—Å—Ç—å", 3: "–ü–æ—Ö–º—É—Ä–æ",
                45: "–¢—É–º–∞–Ω", 48: "–ü–∞–º–æ—Ä–æ–∑—å", 51: "–õ–µ–≥–∫–∞ –º—Ä—è–∫–∞", 53: "–ú—Ä—è–∫–∞", 55: "–°–∏–ª—å–Ω–∞ –º—Ä—è–∫–∞",
                56: "–ö—Ä–∏–∂–∞–Ω–∞ –º—Ä—è–∫–∞", 57: "–°–∏–ª—å–Ω–∞ –∫—Ä–∏–∂–∞–Ω–∞ –º—Ä—è–∫–∞", 61: "–ù–µ–≤–µ–ª–∏–∫–∏–π –¥–æ—â", 63: "–î–æ—â",
                65: "–°–∏–ª—å–Ω–∏–π –¥–æ—â", 66: "–ö—Ä–∏–∂–∞–Ω–∏–π –¥–æ—â", 67: "–°–∏–ª—å–Ω–∏–π –∫—Ä–∏–∂–∞–Ω–∏–π –¥–æ—â", 71: "–ù–µ–≤–µ–ª–∏–∫–∏–π —Å–Ω—ñ–≥",
                73: "–°–Ω—ñ–≥", 75: "–°–∏–ª—å–Ω–∏–π —Å–Ω—ñ–≥", 77: "–°–Ω—ñ–≥–æ–≤–∞ –∫—Ä—É–ø–∞", 80: "–ó–ª–∏–≤–∏", 81: "–ó–ª–∏–≤–∏",
                82: "–°–∏–ª—å–Ω—ñ –∑–ª–∏–≤–∏", 85: "–°–Ω—ñ–≥–æ–ø–∞–¥", 86: "–°–∏–ª—å–Ω–∏–π —Å–Ω—ñ–≥–æ–ø–∞–¥", 95: "–ì—Ä–æ–∑–∞",
                96: "–ì—Ä–æ–∑–∞ –∑ –≥—Ä–∞–¥–æ–º", 99: "–ì—Ä–æ–∑–∞ –∑ —Å–∏–ª—å–Ω–∏–º –≥—Ä–∞–¥–æ–º"
            },
            moonPhases: [
                { name: "–ù–æ–≤–∏–π –º—ñ—Å—è—Ü—å", emoji: "üåë" }, { name: "–ú–æ–ª–æ–¥–∏–π –º—ñ—Å—è—Ü—å", emoji: "üåí" },
                { name: "–ü–µ—Ä—à–∞ —á–≤–µ—Ä—Ç—å", emoji: "üåì" }, { name: "–ü—Ä–∏–±—É–≤–∞—é—á–∏–π", emoji: "üåî" },
                { name: "–ü–æ–≤–Ω–∏–π –º—ñ—Å—è—Ü—å", emoji: "üåï" }, { name: "–°–ø–∞–¥–∞—é—á–∏–π", emoji: "üåñ" },
                { name: "–û—Å—Ç–∞–Ω–Ω—è —á–≤–µ—Ä—Ç—å", emoji: "üåó" }, { name: "–°—Ç–∞—Ä–∏–π –º—ñ—Å—è—Ü—å", emoji: "üåò" }
            ],
            uvLevels: [
                { max: 2, text: "–ù–∏–∑—å–∫–∏–π", color: "text-green-500" },
                { max: 5, text: "–ü–æ–º—ñ—Ä–Ω–∏–π", color: "text-yellow-500" },
                { max: 7, text: "–í–∏—Å–æ–∫–∏–π", color: "text-orange-500" },
                { max: 10, text: "–î—É–∂–µ –≤–∏—Å–æ–∫–∏–π", color: "text-red-500" },
                { max: Infinity, text: "–ï–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏–π", color: "text-purple-500" }
            ],
            aqiLevels: [
                { max: 20, status: "–ß—É–¥–æ–≤–∞", color: "text-green-500", bg: "bg-green-500/20", border: "border-green-500/50" },
                { max: 40, status: "–î–æ–±—Ä–∞", color: "text-lime-500", bg: "bg-lime-500/20", border: "border-lime-500/50" },
                { max: 60, status: "–ü–æ—Å–µ—Ä–µ–¥–Ω—è", color: "text-yellow-500", bg: "bg-yellow-500/20", border: "border-yellow-500/50" },
                { max: 80, status: "–ü–æ–≥–∞–Ω–∞", color: "text-orange-500", bg: "bg-orange-500/20", border: "border-orange-500/50" },
                { max: 100, status: "–î—É–∂–µ –ø–æ–≥–∞–Ω–∞", color: "text-red-500", bg: "bg-red-500/20", border: "border-red-500/50" },
                { max: Infinity, status: "–ù–µ–±–µ–∑–ø–µ—á–Ω–∞", color: "text-purple-500", bg: "bg-purple-500/20", border: "border-purple-500/50" }
            ],
            defaultCity: { lat: 50.45, lon: 30.52, name: "–ö–∏—ó–≤", code: "ua" }
        };

        const ICONS = {
            // SVG strings remain same as before, simplified for this block
            clearDay: `<svg viewBox="0 0 64 64" width="100%" height="100%"><circle cx="32" cy="32" r="12" fill="#fbbf24"/><path stroke="#fbbf24" stroke-width="3" stroke-linecap="round" d="M32 6v8m0 36v8m-26-26h8m36 0h8m-37-17l4 4m22 22l4 4m-30 0l4-4m22-22l4-4"/></svg>`,
            clearNight: `<svg viewBox="0 0 64 64" width="100%" height="100%"><path d="M40 18 A16 16 0 1 1 18 40 A12 12 0 0 0 40 18Z" fill="#e2e8f0"/><circle cx="48" cy="14" r="1.5" fill="#fef3c7"/><circle cx="54" cy="26" r="1" fill="#fef3c7"/></svg>`,
            cloudy: `<svg viewBox="0 0 64 64" width="100%" height="100%"><path d="M14 44 A12 12 0 0 1 24 24 A16 16 0 0 1 52 36 A10 10 0 0 1 44 52 H20 A12 12 0 0 1 14 44" fill="#94a3b8" stroke="#64748b" stroke-width="1"/></svg>`,
            rain: `<svg viewBox="0 0 64 64" width="100%" height="100%"><path d="M14 34 A10 10 0 0 1 24 18 A14 14 0 0 1 50 28 A8 8 0 0 1 42 40 H20 A10 10 0 0 1 14 34" fill="#64748b"/><line x1="20" y1="46" x2="16" y2="58" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/><line x1="32" y1="46" x2="28" y2="58" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/><line x1="44" y1="46" x2="40" y2="58" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/></svg>`,
            snow: `<svg viewBox="0 0 64 64" width="100%" height="100%"><path d="M14 34 A10 10 0 0 1 24 18 A14 14 0 0 1 50 28 A8 8 0 0 1 42 40 H20 A10 10 0 0 1 14 34" fill="#cbd5e1"/><circle cx="20" cy="52" r="3" fill="#fff"/><circle cx="32" cy="56" r="2.5" fill="#fff"/><circle cx="44" cy="50" r="3" fill="#fff"/></svg>`
        };

        // --- STATE MANAGEMENT ---
        const State = {
            city: {...CONFIG.defaultCity},
            history: [],
            timezone: 'Europe/Kyiv',
            weatherData: null,
            chart: null,
            localTimeInterval: null,

            load() {
                try {
                    const s = localStorage.getItem('meteo_v9_state');
                    const h = localStorage.getItem('meteo_v9_history');
                    const t = localStorage.getItem('meteo_v9_theme');
                    if (s) this.city = JSON.parse(s);
                    if (h) this.history = JSON.parse(h);
                    if (t) document.body.className = t;
                } catch (e) { console.warn(e); }
            },
            save() {
                localStorage.setItem('meteo_v9_state', JSON.stringify(this.city));
                localStorage.setItem('meteo_v9_history', JSON.stringify(this.history));
                localStorage.setItem('meteo_v9_theme', document.body.className);
            },
            addToHistory(city) {
                this.history = this.history.filter(c => c.name !== city.name);
                this.history.unshift(city);
                if (this.history.length > 5) this.history.pop();
                this.save();
            }
        };

        // --- API CALLS ---
        const API = {
            async fetchWeather() {
                const {lat, lon} = State.city;
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,is_day,weather_code,relative_humidity_2m,surface_pressure,wind_speed_10m,uv_index&hourly=temperature_2m,precipitation_probability&daily=temperature_2m_max,temperature_2m_min,weather_code,sunrise,sunset,uv_index_max&timezone=auto&forecast_days=14`);
                if(!r.ok) throw new Error();
                const d = await r.json();
                State.timezone = d.timezone;
                return d;
            },
            async fetchAirQuality() {
                const {lat, lon} = State.city;
                const r = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=european_aqi,pm10,pm2_5,nitrogen_dioxide,ozone,alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen,dust`);
                return r.ok ? r.json() : null;
            },
            async searchCities(query) {
                const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=uk&format=json`);
                return r.ok ? r.json() : {results:[]};
            }
        };

        // --- UTILS ---
        const Utils = {
            getWeatherIcon(code, isDay) {
                if (code === 0) return isDay ? ICONS.clearDay : ICONS.clearNight;
                if (code <= 3) return ICONS.cloudy;
                if (code >= 71) return ICONS.snow;
                return ICONS.rain; // Simplified fallback
            },
            getPollenLevel(value) {
                const val = value || 0; // Handle null/undefined as 0
                if (val === 0) return { text: '–í—ñ–¥—Å—É—Ç–Ω—ñ–π', class: 'text-emerald-500', dot: 'bg-emerald-500' };
                if (val < 10) return { text: '–ù–∏–∑—å–∫–∏–π', class: 'text-green-500', dot: 'bg-green-500' };
                if (val < 30) return { text: '–ü–æ–º—ñ—Ä–Ω–∏–π', class: 'text-yellow-500', dot: 'bg-yellow-500' };
                if (val < 60) return { text: '–í–∏—Å–æ–∫–∏–π', class: 'text-orange-500', dot: 'bg-orange-500' };
                return { text: '–ï–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏–π', class: 'text-red-500', dot: 'bg-red-500' };
            },
            formatTime: (d) => new Date(d).toLocaleTimeString('uk-UA', {hour:'2-digit', minute:'2-digit', timeZone: State.timezone}),
        };

        // --- UI RENDERER ---
        const UI = {
            $: (id) => document.getElementById(id),
            
            update(weather, aqiData) {
                this.renderSidebar(weather);
                this.renderChart(weather.hourly);
                this.renderDaily(weather.daily);
                this.renderAstro(weather.daily);
                if (aqiData) {
                    this.renderAQI(aqiData);
                    this.renderPollen(aqiData);
                }
            },

            renderSidebar(data) {
                const cur = data.current;
                this.$('city-name').textContent = State.city.name;
                this.$('flag').src = `https://flagcdn.com/48x36/${State.city.code}.png`;
                this.$('date-display').textContent = new Date().toLocaleDateString('uk-UA', {weekday:'long', day:'numeric', month:'long'});
                
                this.$('main-icon').innerHTML = Utils.getWeatherIcon(cur.weather_code, cur.is_day);
                this.$('main-temp').textContent = Math.round(cur.temperature_2m) + '¬∞';
                this.$('weather-desc').textContent = CONFIG.weatherDescriptions[cur.weather_code] || '---';
                
                this.$('feels-like').textContent = Math.round(cur.apparent_temperature) + '¬∞';
                this.$('humidity').textContent = cur.relative_humidity_2m + '%';
                this.$('wind').textContent = (cur.wind_speed_10m / 3.6).toFixed(1) + ' –º/—Å';
                this.$('pressure').textContent = Math.round(cur.surface_pressure) + ' –≥–ü–∞';

                const uv = Math.round(cur.uv_index);
                const uvLvl = CONFIG.uvLevels.find(l => uv <= l.max);
                this.$('uv-value').textContent = uv;
                this.$('uv-value').className = `text-sm font-bold ${uvLvl.color}`;
                this.$('uv-text').textContent = uvLvl.text;
                this.$('uv-marker').style.left = Math.min((uv/11)*100, 100) + '%';
            },

            renderChart(hourly) {
                const ctx = this.$('weatherChart')?.getContext('2d');
                if (!ctx) return;
                if (State.chart) State.chart.destroy();
                
                const isDark = document.body.classList.contains('dark');
                const textColor = isDark ? '#e2e8f0' : '#334155';
                const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

                State.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hourly.time.slice(0, 24).map(t => t.split('T')[1].slice(0, 5)),
                        datasets: [
                            {
                                type: 'line',
                                label: '–¢–µ–º–ø',
                                data: hourly.temperature_2m.slice(0, 24),
                                borderColor: '#3b82f6',
                                backgroundColor: gradient,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: isDark ? '#fff' : '#334155',
                                datalabels: {
                                    color: textColor,
                                    align: 'top',
                                    offset: 4,
                                    font: {weight: 'bold'},
                                    formatter: Math.round
                                }
                            }
                        ]
                    },
                    plugins: [ChartDataLabels],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: {display: false}, tooltip: {enabled: true} },
                        scales: {
                            x: { grid: {display: false}, ticks: {color: textColor} },
                            y: { display: false }
                        }
                    }
                });
            },

            renderDaily(daily) {
                this.$('daily-grid').innerHTML = daily.time.map((t, i) => {
                    const d = new Date(t);
                    const name = i===0 ? '–°—å–æ–≥–æ–¥–Ω—ñ' : d.toLocaleDateString('uk-UA', {weekday:'long'});
                    const icon = Utils.getWeatherIcon(daily.weather_code[i], 1);
                    return `
                    <div class="glass p-4 rounded-xl flex items-center justify-between hover:bg-white/5 transition">
                        <div class="flex flex-col">
                            <span class="font-bold text-primary capitalize">${name}</span>
                            <span class="text-[10px] text-blue-500">${CONFIG.weatherDescriptions[daily.weather_code[i]]}</span>
                        </div>
                        <div class="w-10 h-10 mx-2">${icon}</div>
                        <div class="text-right">
                            <span class="font-bold text-primary block">${Math.round(daily.temperature_2m_max[i])}¬∞</span>
                            <span class="text-xs text-secondary">${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                        </div>
                    </div>`;
                }).join('');
            },

            renderAQI(data) {
                const cur = data.current;
                const aqi = Math.round(cur.european_aqi || 0);
                const lvl = CONFIG.aqiLevels.find(l => aqi <= l.max);
                
                this.$('aqi-value').textContent = aqi;
                this.$('aqi-status').textContent = lvl.status;
                this.$('aqi-status').className = `text-xl md:text-2xl font-bold px-6 py-2 rounded-full border backdrop-blur-md mb-4 shadow-lg ${lvl.color} ${lvl.border} ${lvl.bg}`;
                
                // Bars
                const setBar = (id, val, max) => {
                    this.$(`pol-${id}`).textContent = val.toFixed(1);
                    this.$(`${id}-bar`).style.width = Math.min((val/max)*100, 100) + '%';
                };
                setBar('pm25', cur.pm2_5, 50);
                setBar('pm10', cur.pm10, 100);
                setBar('no2', cur.nitrogen_dioxide, 200);
                setBar('o3', cur.ozone, 180);
                
                // Health Recs
                const recs = aqi <= 40 ? 
                    [{icon:'üèÉ',t:'–°–ø–æ—Ä—Ç',d:'–ú–æ–∂–Ω–∞ –∑–∞–π–º–∞—Ç–∏—Å—è –Ω–∞–¥–≤–æ—Ä—ñ'}, {icon:'üë∂',t:'–î—ñ—Ç–∏',d:'–ë–µ–∑–ø–µ—á–Ω–æ –≥—É–ª—è—Ç–∏'}, {icon:'ü™ü',t:'–í—ñ–∫–Ω–∞',d:'–ú–æ–∂–Ω–∞ –ø—Ä–æ–≤—ñ—Ç—Ä—é–≤–∞—Ç–∏'}] :
                    [{icon:'üò∑',t:'–ú–∞—Å–∫–∞',d:'–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è —á—É—Ç–ª–∏–≤–∏—Ö'}, {icon:'üè†',t:'–ü—Ä–∏–º—ñ—â–µ–Ω–Ω—è',d:'–ö—Ä–∞—â–µ –∑–∞–ª–∏—à–∞—Ç–∏—Å—è –≤–¥–æ–º–∞'}, {icon:'üí®',t:'–û—á–∏—â–µ–Ω–Ω—è',d:'–£–≤—ñ–º–∫–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏'}];
                
                this.$('health-recommendations').innerHTML = recs.map(r => `
                    <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5 border border-white/5">
                        <span class="text-2xl">${r.icon}</span>
                        <div><h5 class="font-bold text-primary text-sm">${r.t}</h5><p class="text-xs text-secondary">${r.d}</p></div>
                    </div>
                `).join('');
            },

            // --- FIXED POLLEN RENDERER ---
            renderPollen(data) {
                const c = data.current;
                this.$('pollen-date').textContent = new Date().toLocaleDateString('uk-UA', {day:'numeric', month:'long'});

                const createRow = (label, val) => {
                    // Force 0 if null/undefined
                    const safeVal = (val === null || val === undefined) ? 0 : val;
                    const lvl = Utils.getPollenLevel(safeVal);
                    return `
                        <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition group">
                            <span class="text-sm text-secondary font-medium group-hover:text-primary transition-colors">${label}</span>
                            <div class="leader-line border-b-2 border-dotted border-white/20"></div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${lvl.dot}"></span>
                                <span class="font-bold text-lg tabular-nums ${lvl.class}">${Math.round(safeVal)}</span>
                            </div>
                        </div>
                    `;
                };

                this.$('group-trees').innerHTML = 
                    createRow('–í—ñ–ª—å—Ö–∞', c.alder_pollen) + 
                    createRow('–ë–µ—Ä–µ–∑–∞', c.birch_pollen) +
                    createRow('–î—É–±', null); // API often missing Oak, explicit null test
                
                this.$('group-grass').innerHTML = 
                    createRow('–ó–ª–∞–∫–æ–≤—ñ', c.grass_pollen) +
                    createRow('–ê–º–±—Ä–æ–∑—ñ—è', c.ragweed_pollen) +
                    createRow('–ü–æ–ª–∏–Ω', c.mugwort_pollen);

                this.$('group-other').innerHTML = 
                    createRow('–û–ª–∏–≤–∫–∏', c.olive_pollen) +
                    createRow('–ü–∏–ª', c.dust);
                
                // Tips based on max pollen
                const maxVal = Math.max(c.alder_pollen||0, c.birch_pollen||0, c.grass_pollen||0, c.ragweed_pollen||0);
                const tips = maxVal < 10 ? 
                    ['‚úÖ –ß—É–¥–æ–≤–∏–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª—è–Ω–æ–∫', 'ü™ü –°–º—ñ–ª–∏–≤–æ –ø—Ä–æ–≤—ñ—Ç—Ä—é–π—Ç–µ'] : 
                    ['üíä –¢—Ä–∏–º–∞–π—Ç–µ –ª—ñ–∫–∏ –ø–æ—Ä—É—á', 'üöø –ü—Ä–∏–π–º—ñ—Ç—å –¥—É—à –ø—ñ—Å–ª—è –≤—É–ª–∏—Ü—ñ'];
                
                this.$('allergy-tips').innerHTML = tips.map(t => `<div class="p-3 rounded-lg bg-white/5 text-sm text-secondary border border-white/5">${t}</div>`).join('');
            },

            renderAstro(daily) {
                const sunrise = new Date(daily.sunrise[0]);
                const sunset = new Date(daily.sunset[0]);
                
                this.$('sunrise').textContent = Utils.formatTime(sunrise);
                this.$('sunset').textContent = Utils.formatTime(sunset);
                
                this.$('astro-start').textContent = Utils.formatTime(sunrise);
                this.$('astro-end').textContent = Utils.formatTime(sunset);
                
                const dayDuration = (sunset - sunrise) / 3600000;
                this.$('arc-duration').textContent = dayDuration.toFixed(1) + ' –≥–æ–¥';

                const isDay = new Date() > sunrise && new Date() < sunset;
                this.$('day-night-status').textContent = isDay ? '‚òÄÔ∏è –î–µ–Ω—å' : 'üåô –ù—ñ—á';
                this.$('day-night-status').className = `text-lg font-bold ${isDay ? 'text-yellow-500' : 'text-blue-500'}`;
                
                // Moon (Simulated calculation)
                const moon = new Date(); // Simplified phase logic for demo
                this.$('moon-phase-name').textContent = "–ó—Ä–æ—Å—Ç–∞—é—á–∏–π";
                this.$('moon-illumination').textContent = "45%";
                this.$('moon-age').textContent = "–î–µ–Ω—å 8";
            }
        };

        // --- APP CONTROLLER ---
        const App = {
            init() {
                State.load();
                this.bindEvents();
                this.updateAll();
                // Clock
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('local-time').textContent = now.toLocaleTimeString('uk-UA');
                }, 1000);
            },
            
            bindEvents() {
                // Search
                const modal = document.getElementById('search-modal');
                const closeSearch = () => modal.classList.remove('active');
                
                document.getElementById('btn-search').onclick = () => {
                    modal.classList.add('active');
                    document.getElementById('search-input').focus();
                };
                document.getElementById('btn-close-search').onclick = closeSearch;
                document.getElementById('search-backdrop').onclick = closeSearch;
                
                let debounce;
                document.getElementById('search-input').oninput = (e) => {
                    clearTimeout(debounce);
                    debounce = setTimeout(async () => {
                        if(e.target.value.length < 2) return;
                        const data = await API.searchCities(e.target.value);
                        document.getElementById('search-results').innerHTML = data.results?.map(c => `
                            <button class="w-full text-left p-4 glass rounded-xl mb-2 flex justify-between items-center hover:bg-white/10" onclick="App.selectCity('${c.name}','${c.country_code}','${c.latitude}','${c.longitude}')">
                                <span class="font-bold text-primary">${c.name}</span>
                                <span class="text-xs text-secondary">${c.country || ''}</span>
                            </button>
                        `).join('') || '<div class="text-center text-secondary">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                    }, 300);
                };

                // Theme
                document.getElementById('btn-theme').onclick = () => {
                    const body = document.body;
                    body.classList.toggle('dark');
                    body.classList.toggle('light');
                    State.save();
                    // Re-render chart to fix colors
                    if(State.weatherData) UI.renderChart(State.weatherData.hourly);
                };

                // Tabs
                document.querySelectorAll('[data-tab]').forEach(b => {
                    b.onclick = () => {
                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        b.classList.add('active');
                        document.getElementById(`tab-${b.dataset.tab}`).classList.add('active');
                    };
                });
                
                // Geolocation
                document.getElementById('btn-locate').onclick = () => {
                    navigator.geolocation.getCurrentPosition(pos => {
                        App.selectCity('–ú–æ—î –º—ñ—Å—Ü–µ', 'ua', pos.coords.latitude, pos.coords.longitude);
                    }, () => alert('–ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó'));
                };
            },

            async updateAll() {
                try {
                    const weather = await API.fetchWeather();
                    const aqi = await API.fetchAirQuality();
                    State.weatherData = weather;
                    UI.update(weather, aqi);
                    lucide.createIcons();
                } catch(e) { console.error(e); }
            },

            selectCity(name, code, lat, lon) {
                State.city = {name, code: code.toLowerCase(), lat, lon};
                State.addToHistory(State.city);
                document.getElementById('search-modal').classList.remove('active');
                this.updateAll();
            }
        };

        // Assign global for HTML onclick access
        window.App = App;
        App.init();
    })();
    </script>
</body>
</html>
