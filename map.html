<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iWeather: Interactive</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1) !important;
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(12px);
            border-radius: 1.2rem !important;
            width: 100% !important; max-width: 100% !important;
        }
        .mapboxgl-ctrl-geocoder--input { height: 50px !important; padding-left: 45px !important; font-size: 16px !important; color: #334155 !important; }
        .mapboxgl-ctrl-geocoder--icon-search { top: 12px !important; left: 12px !important; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .accordion-content { transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-item.active .accordion-content { max-height: 120px; opacity: 1; }
        .accordion-arrow { transition: transform 0.3s ease; }
        .accordion-item.active .accordion-arrow { transform: rotate(180deg); }

        /* Radio Visualizer */
        .bar { width: 4px; background: #3b82f6; border-radius: 2px; height: 4px; }
        .radio-playing .bar { animation: sound 0ms -800ms linear infinite alternate; }
        @keyframes sound { 0% { height: 4px; opacity: .5; } 100% { height: 24px; opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-slate-100 text-slate-800 font-sans">

    <div id="map" class="absolute inset-0 z-0"></div>
    <div class="absolute top-5 left-4 right-4 z-30 md:w-96 md:left-8"><div id="geocoder"></div></div>

    <div id="panel" class="absolute z-20 
        w-full h-[65vh] bottom-0 left-0 rounded-t-[2.5rem] 
        md:w-[440px] md:h-[90vh] md:top-24 md:left-8 md:bottom-8 md:rounded-[2.5rem]
        glass-panel shadow-2xl flex flex-col transition-transform duration-500 translate-y-full md:translate-y-0 md:-translate-x-[120%]">
        
        <div class="w-full flex justify-center pt-3 pb-1 md:hidden" onclick="togglePanel()">
            <div class="w-12 h-1.5 bg-slate-300/80 rounded-full"></div>
        </div>

        <div class="px-8 pt-5 pb-2 flex justify-between items-end">
            <div>
                <h1 id="ui-city" class="text-3xl font-black text-slate-900 tracking-tight leading-none truncate max-w-[200px]">City</h1>
                <div id="ui-time" class="text-sm font-bold text-blue-600 mt-1">--:--</div>
            </div>
            <div class="text-right">
                <div id="ui-temp" class="text-6xl font-black text-slate-800 tracking-tighter">--¬∞</div>
                <div id="ui-desc" class="text-xs font-bold text-slate-500 uppercase tracking-wide mt-1">--</div>
            </div>
        </div>

        <div class="px-6 py-4">
            <div class="flex bg-slate-200/60 p-1 rounded-2xl">
                <button onclick="setTab('weather')" class="tab-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-600 transition-all shadow-sm bg-white" id="btn-weather">–ü–æ–≥–æ–¥–∞</button>
                <button onclick="setTab('explore')" class="tab-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-400 hover:text-slate-600 transition-all" id="btn-explore">–ú–∞–Ω–¥—Ä—ñ–≤–Ω–∏–∫</button>
                <button onclick="setTab('radio')" class="tab-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-400 hover:text-slate-600 transition-all" id="btn-radio">–†–∞–¥—ñ–æ</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar px-6 pb-8 relative">
            
            <div id="tab-weather" class="tab-content space-y-6 fade-in">
                <div>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 pl-1">–ö–æ–º—Ñ–æ—Ä—Ç</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/60 p-4 rounded-3xl border border-white/60 shadow-sm flex flex-col justify-between h-28"><span class="text-2xl">üëï</span><div><div class="text-[10px] font-bold text-slate-400 uppercase">–û–¥—è–≥</div><div class="text-xs font-bold text-slate-800 leading-tight mt-0.5" id="txt-clothes">--</div></div></div>
                        <div id="card-aqi" class="bg-white/60 p-4 rounded-3xl border border-white/60 shadow-sm flex flex-col justify-between h-28"><span class="text-2xl">üò∑</span><div><div class="text-[10px] font-bold text-slate-400 uppercase">–ü–æ–≤—ñ—Ç—Ä—è</div><div class="text-xs font-bold text-slate-800 leading-tight mt-0.5" id="txt-aqi">--</div></div></div>
                        <div id="card-poodle" class="bg-white/60 p-4 rounded-3xl border border-white/60 shadow-sm flex flex-col justify-between h-28"><span class="text-2xl">üê©</span><div><div class="text-[10px] font-bold text-slate-400 uppercase">–ó–∞—á—ñ—Å–∫–∞</div><div class="text-xs font-bold text-slate-800 leading-tight mt-0.5" id="txt-poodle">--</div></div></div>
                        <div id="card-migraine" class="bg-white/60 p-4 rounded-3xl border border-white/60 shadow-sm flex flex-col justify-between h-28"><div class="flex justify-between"><span class="text-2xl">üß†</span><div class="h-2.5 w-2.5 rounded-full bg-slate-300" id="dot-migraine"></div></div><div><div class="text-[10px] font-bold text-slate-400 uppercase">–ú—ñ–≥—Ä–µ–Ω—å</div><div class="text-xs font-bold text-slate-800 leading-tight mt-0.5" id="txt-migraine">--</div></div></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-3 pl-1 pr-1">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">–ü—Ä–æ–≥–Ω–æ–∑</h3>
                        <div class="text-[10px] font-bold text-slate-500 bg-white/60 px-2.5 py-1 rounded-lg border border-white/50">üåÖ <span id="time-sunrise">--</span> ‚Ä¢ üåá <span id="time-sunset">--</span></div>
                    </div>
                    <div id="forecast-container" class="space-y-2"></div>
                </div>
            </div>

            <div id="tab-explore" class="tab-content hidden space-y-6 fade-in">
                
                <div class="relative w-full h-40 rounded-[2rem] overflow-hidden shadow-lg group">
                    <img id="img-flag" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" src="">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex flex-col justify-end p-6">
                        <h2 class="text-white text-2xl font-bold tracking-tight leading-none" id="txt-country">--</h2>
                    </div>
                </div>

                <div class="bg-white/60 rounded-3xl overflow-hidden border border-white/60 shadow-sm divide-y divide-slate-100/50">
                    <div class="flex justify-between items-center p-4"><span class="text-xs font-bold text-slate-500">–°—Ç–æ–ª–∏—Ü—è</span><span class="text-sm font-bold text-slate-800" id="txt-capital">--</span></div>
                    <div class="flex justify-between items-center p-4"><span class="text-xs font-bold text-slate-500">–ù–∞—Å–µ–ª–µ–Ω–Ω—è</span><span class="text-sm font-bold text-slate-800" id="txt-pop">--</span></div>
                    <div class="flex justify-between items-center p-4"><span class="text-xs font-bold text-slate-500">–†—É—Ö –∞–≤—Ç–æ</span><span class="text-sm font-bold text-slate-800" id="txt-drive">--</span></div>
                    <div class="flex justify-between items-center p-4 bg-blue-50/50"><div class="flex flex-col"><span class="text-[10px] font-bold text-blue-400 uppercase">–°–≤—è—Ç–æ</span><span class="text-sm font-bold text-blue-900 truncate max-w-[150px]" id="txt-holiday">--</span></div><span class="text-xs font-semibold text-blue-600 bg-white px-2 py-1 rounded-md shadow-sm" id="txt-holiday-date">--</span></div>
                </div>

                <div>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 pl-1">üçª –ë–∞—Ä–∏ –ø–æ—Ä—É—á</h3>
                    <div id="breweries-container" class="space-y-2">
                        <span class="text-xs text-slate-400 pl-1">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                    </div>
                </div>

                <div>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 pl-1">üèõÔ∏è –©–æ –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</h3>
                    <div id="wiki-container" class="space-y-2">
                        <span class="text-xs text-slate-400 pl-1">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                    </div>
                </div>
            </div>

            <div id="tab-radio" class="tab-content hidden h-full flex flex-col items-center pt-6 fade-in">
                <div id="radio-cover" class="w-52 h-52 rounded-[3rem] bg-gradient-to-br from-slate-800 to-black shadow-2xl flex items-center justify-center mb-8 relative border-4 border-white/20">
                    <svg class="w-20 h-20 text-blue-500 drop-shadow-lg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    <div class="absolute bottom-4 bg-white/10 backdrop-blur-md border border-white/10 px-3 py-1 rounded-full flex items-center gap-2">
                        <span id="radio-led" class="w-2 h-2 rounded-full bg-slate-500"></span>
                        <span id="radio-status" class="text-[10px] font-bold text-white uppercase tracking-wider">OFFLINE</span>
                    </div>
                </div>
                <div class="mb-8 w-full px-4 text-center">
                    <h2 class="text-xl font-black text-slate-800 mb-1 truncate leading-tight" id="radio-title">–û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É</h2>
                    <div class="flex items-end justify-center gap-1.5 h-4" id="visualizer"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                </div>
                <div class="flex items-center gap-6 bg-white p-4 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100">
                    <button id="btn-prev" class="w-14 h-14 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition-all"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button id="btn-play" class="w-20 h-20 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl shadow-lg shadow-blue-500/40 hover:bg-blue-700 active:scale-95 transition-all group"><svg id="icon-play" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><svg id="icon-pause" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
                    <button id="btn-next" class="w-14 h-14 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition-all"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                </div>
                <audio id="audio-player"></audio>
            </div>

        </div>
    </div>

    <button id="toggle-3d" class="absolute bottom-28 right-4 md:bottom-8 md:right-8 z-30 w-12 h-12 bg-white rounded-2xl shadow-xl border border-white/50 text-xl flex items-center justify-center active:scale-90 transition-all text-slate-600 hover:text-blue-600">üè¢</button>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGVpc3NlbiIsImEiOiJjbWl0eGIyMHAwYWNrM2RzOGVnOGVyZnFmIn0.Px59SHwajQl0jgVAxzEmsA';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [30.52, 50.45], zoom: 11, pitch: 0, projection: 'globe'
    });

    map.on('style.load', () => {
        map.setFog({ 'color': 'rgb(255, 255, 255)', 'high-color': 'rgb(220, 235, 255)', 'horizon-blend': 0.1 });
        add3DLayer();
    });

    const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false, placeholder: '–ó–Ω–∞–π—Ç–∏ –º—ñ—Å—Ç–æ...', language: 'uk' });
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
    
    // Primary Marker
    let mainMarker = new mapboxgl.Marker({ color: '#2563eb' });
    // Temporary Marker for POIs
    let tempMarker = null;

    const btn3D = document.getElementById('toggle-3d');
    function add3DLayer() {
        if(map.getLayer('3d-buildings')) return;
        const layers = map.getStyle().layers;
        const labelId = layers.find(l => l.type === 'symbol' && l.layout['text-field'])?.id;
        map.addLayer({
            'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'filter': ['==', 'extrude', 'true'], 'type': 'fill-extrusion', 'minzoom': 13, 'layout': { 'visibility': 'none' },
            'paint': { 'fill-extrusion-color': '#cbd5e1', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-base': ['get', 'min_height'], 'fill-extrusion-opacity': 0.8 }
        }, labelId);
    }
    btn3D.addEventListener('click', () => {
        if(!map.getLayer('3d-buildings')) return;
        const isVis = map.getLayoutProperty('3d-buildings', 'visibility') === 'visible';
        map.setLayoutProperty('3d-buildings', 'visibility', isVis ? 'none' : 'visible');
        map.easeTo({ pitch: isVis ? 0 : 55 });
        btn3D.classList.toggle('bg-blue-600'); btn3D.classList.toggle('text-white');
    });

    window.setTab = (tabName) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('bg-white', 'text-slate-600', 'shadow-sm'); btn.classList.add('text-slate-400'); });
        document.getElementById(`btn-${tabName}`).classList.add('bg-white', 'text-slate-600', 'shadow-sm');
        document.getElementById(`btn-${tabName}`).classList.remove('text-slate-400');
    };

    function togglePanel() {
        const panel = document.getElementById('panel');
        if(panel.classList.contains('translate-y-0')) { panel.classList.remove('translate-y-0'); panel.classList.add('translate-y-full'); } 
        else { panel.classList.remove('translate-y-full'); panel.classList.add('translate-y-0'); }
    }
    function openPanel() { const panel = document.getElementById('panel'); panel.classList.remove('translate-y-full', 'md:-translate-x-[120%]'); panel.classList.add('translate-y-0', 'md:translate-x-0'); }

    // --- INTERACTIVE MAP LOGIC ---
    // Function to fly to a specific place (Wiki/Bar) and show it
    window.showOnMap = function(lat, lng) {
        // Remove old temp marker if exists
        if(tempMarker) tempMarker.remove();
        
        // Add new distinct marker (Orange)
        tempMarker = new mapboxgl.Marker({ color: '#f97316' })
            .setLngLat([lng, lat])
            .addTo(map);
            
        map.flyTo({ center: [lng, lat], zoom: 15, speed: 1.5, pitch: 45 });
        
        // On mobile, maybe minimize panel slightly or ensure map is visible?
        // Current behavior: Map centers, so it should be visible above the panel.
    };

    map.on('click', (e) => reverseGeocode(e.lngLat.lat, e.lngLat.lng));
    geocoder.on('result', (e) => {
        const c = e.result.context ? e.result.context.find(x => x.id.startsWith('country')) : null;
        loadData(e.result.center[1], e.result.center[0], e.result.text, c?.short_code);
    });

    async function reverseGeocode(lat, lng) {
        // Remove temp marker on map click to clean up
        if(tempMarker) { tempMarker.remove(); tempMarker = null; }

        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=place,country&language=uk&access_token=${mapboxgl.accessToken}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            let city = "–õ–æ–∫–∞—Ü—ñ—è"; let code = null;
            if(data.features.length) {
                const p = data.features.find(f => f.place_type.includes('place')) || data.features.find(f => f.place_type.includes('country'));
                if(p) city = p.text;
                const c = data.features.find(f => f.place_type.includes('country'));
                if(c) code = c.properties.short_code;
            }
            loadData(lat, lng, city, code);
        } catch(e) { loadData(lat, lng, "–¢–æ—á–∫–∞", null); }
    }

    async function loadData(lat, lng, city, code) {
        mainMarker.setLngLat([lng, lat]).addTo(map);
        map.flyTo({ center: [lng, lat], zoom: 12 });
        openPanel();

        document.getElementById('ui-city').innerText = city;
        document.getElementById('ui-desc').innerText = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weathercode,surface_pressure&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset&timezone=auto&forecast_days=6`;
        const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lng}&current=european_aqi`;

        try {
            const [wRes, aRes] = await Promise.all([fetch(weatherUrl), fetch(aqiUrl)]);
            const wData = await wRes.json();
            const aData = await aRes.json();
            renderWeather(wData, aData);
        } catch(e) { console.error(e); }

        if(code) {
            loadCountryInfo(code);
            setupRadio(code);
        } else {
             document.getElementById('radio-title').innerText = "–ù–µ–º–∞—î —Ä–∞–¥—ñ–æ";
             document.getElementById('txt-country').innerText = "–ù–µ–≤—ñ–¥–æ–º–æ";
             document.getElementById('img-flag').src = "";
        }
        
        loadNearbyWiki(lat, lng);
        loadBreweries(lat, lng);
    }

    function renderWeather(wData, aData) {
        const c = wData.current;
        const d = wData.daily;
        const wInfo = getWInfo(c.weathercode);
        
        document.getElementById('ui-temp').innerText = Math.round(c.temperature_2m) + '¬∞';
        document.getElementById('ui-desc').innerText = wInfo.text;
        document.getElementById('ui-time').innerText = new Date().toLocaleTimeString('uk-UA', {timeZone: wData.timezone, hour:'2-digit', minute:'2-digit'});

        const aqi = aData.current ? aData.current.european_aqi : 0;
        const aqiBox = document.getElementById('card-aqi');
        const aqiTxt = document.getElementById('txt-aqi');
        
        if(aqi < 20) { aqiBox.className = "bg-green-50 p-4 rounded-3xl border border-green-100 shadow-sm flex flex-col justify-between h-28 transition-transform hover:scale-[1.02]"; aqiTxt.innerText = `–ß–∏—Å—Ç–µ (${aqi})`; }
        else if(aqi < 50) { aqiBox.className = "bg-yellow-50 p-4 rounded-3xl border border-yellow-100 shadow-sm flex flex-col justify-between h-28 transition-transform hover:scale-[1.02]"; aqiTxt.innerText = `–ü–æ–º—ñ—Ä–Ω–µ (${aqi})`; }
        else { aqiBox.className = "bg-red-50 p-4 rounded-3xl border border-red-100 shadow-sm flex flex-col justify-between h-28 transition-transform hover:scale-[1.02]"; aqiTxt.innerText = `–ë—Ä—É–¥–Ω–µ (${aqi})`; }

        updateLifestyle(c);

        document.getElementById('time-sunrise').innerText = new Date(d.sunrise[0]).toLocaleTimeString('uk-UA', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('time-sunset').innerText = new Date(d.sunset[0]).toLocaleTimeString('uk-UA', {hour:'2-digit', minute:'2-digit'});

        const list = document.getElementById('forecast-container');
        list.innerHTML = '';
        const days = ['–ù–¥','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

        for(let i=1; i<6; i++) {
            const date = new Date(d.time[i]);
            const icon = getWInfo(d.weathercode[i]).icon;
            const div = document.createElement('div');
            div.className = "accordion-item bg-white/50 rounded-2xl border border-white/60 overflow-hidden cursor-pointer hover:bg-white/80 transition-all";
            div.innerHTML = `
                <div class="flex justify-between items-center p-4">
                    <div class="flex items-center gap-3 w-20"><span class="text-sm font-bold text-slate-700">${days[date.getDay()]}</span><span class="text-lg">${icon}</span></div>
                    <div class="flex items-center gap-3"><span class="text-sm font-bold text-slate-800">${Math.round(d.temperature_2m_max[i])}¬∞ <span class="text-slate-400 font-normal">${Math.round(d.temperature_2m_min[i])}¬∞</span></span><span class="text-xs text-slate-400 accordion-arrow">‚ñº</span></div>
                </div>
                <div class="accordion-content bg-white/40">
                    <div class="p-4 pt-0 grid grid-cols-2 gap-2 text-xs text-slate-600">
                        <div class="bg-blue-50 p-2 rounded-xl font-semibold text-blue-700 flex items-center justify-center">üíß ${d.precipitation_probability_max[i]}%</div>
                        <div class="bg-slate-100 p-2 rounded-xl font-semibold text-slate-700 flex items-center justify-center">üí® ${d.wind_speed_10m_max[i]} –∫–º/–≥</div>
                    </div>
                </div>
            `;
            div.onclick = function() { document.querySelectorAll('.accordion-item').forEach(el => { if(el !== div) el.classList.remove('active'); }); div.classList.toggle('active'); };
            list.appendChild(div);
        }
    }

    function updateLifestyle(c) {
        let cText = c.apparent_temperature < 10 ? "–ü—É—Ö–æ–≤–∏–∫" : (c.apparent_temperature < 20 ? "–•—É–¥—ñ" : "–§—É—Ç–±–æ–ª–∫–∞");
        document.getElementById('txt-clothes').innerText = `${cText} (${Math.round(c.apparent_temperature)}¬∞)`;
        
        const h = c.relative_humidity_2m;
        const pooBox = document.getElementById('card-poodle');
        let pClass = "bg-white/60 border-white/60";
        let pText = "–Ü–¥–µ–∞–ª—å–Ω–æ";
        if(h>60) { pClass = "bg-yellow-50 border-yellow-100"; pText = "–ü—É—Ö–Ω–∞—Å—Ç–æ"; }
        if(h>80) { pClass = "bg-red-50 border-red-100"; pText = "–•–∞–æ—Å!"; }
        pooBox.className = `p-4 rounded-3xl border shadow-sm flex flex-col justify-between h-28 transition-transform hover:scale-[1.02] ${pClass}`;
        document.getElementById('txt-poodle').innerText = `${pText} (${h}%)`;

        const mDot = document.getElementById('dot-migraine');
        const p = c.surface_pressure;
        if(p<1000||p>1025) { mDot.className = "h-2.5 w-2.5 rounded-full bg-red-500 animate-pulse"; document.getElementById('txt-migraine').innerText = "–†–∏–∑–∏–∫"; }
        else { mDot.className = "h-2.5 w-2.5 rounded-full bg-green-500"; document.getElementById('txt-migraine').innerText = "–°–ø–æ–∫—ñ–π–Ω–æ"; }
    }

    async function loadCountryInfo(code) {
        try {
            const res = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
            const data = await res.json();
            const c = data[0];
            document.getElementById('txt-country').innerText = c.name.common;
            document.getElementById('txt-capital').innerText = c.capital?.[0] || '-';
            document.getElementById('txt-pop').innerText = (c.population/1000000).toFixed(1) + ' –º–ª–Ω';
            document.getElementById('txt-drive').innerText = c.car.side === 'right' ? '–°–ø—Ä–∞–≤–∞' : '–ó–ª—ñ–≤–∞';
            document.getElementById('img-flag').src = c.flags.png;
        } catch(e) {}

        try {
            const hRes = await fetch(`https://date.nager.at/api/v3/NextPublicHolidays/${code}`);
            if(hRes.ok) {
                const hData = await hRes.json();
                if(hData.length) {
                    document.getElementById('txt-holiday').innerText = hData[0].localName;
                    document.getElementById('txt-holiday-date').innerText = hData[0].date;
                }
            }
        } catch(e) { document.getElementById('txt-holiday').innerText = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö"; }
    }

    // --- UPDATED Breweries (With Interaction) ---
    async function loadBreweries(lat, lng) {
        const container = document.getElementById('breweries-container');
        container.innerHTML = '<span class="text-xs text-slate-400 pl-1">–®—É–∫–∞—î–º–æ –ø–∏–≤–æ... üç∫</span>';
        try {
            const res = await fetch(`https://api.openbrewerydb.org/v1/breweries?by_dist=${lat},${lng}&per_page=3`);
            const data = await res.json();
            if(data.length > 0) {
                let html = '';
                data.forEach(b => {
                    let type = b.brewery_type;
                    if(type === 'micro') type = '–ú—ñ–∫—Ä–æ'; if(type === 'brewpub') type = '–ü–∞–±'; if(type === 'bar') type = '–ë–∞—Ä';
                    
                    // Two buttons: Map and Link
                    html += `
                    <div class="bg-white/60 p-3 rounded-2xl border border-white/60 hover:bg-white transition-colors flex justify-between items-center group">
                        <div class="flex-1 overflow-hidden mr-2">
                            <span class="text-xs font-bold text-slate-800 block truncate">${b.name}</span>
                            <span class="text-[10px] font-semibold text-slate-500 uppercase">${type}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showOnMap(${b.latitude}, ${b.longitude})" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-colors text-sm" title="–ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –º–∞–ø—ñ">üìç</button>
                            ${b.website_url ? `<a href="${b.website_url}" target="_blank" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-800 hover:text-white transition-colors text-sm" title="–°–∞–π—Ç">‚Üó</a>` : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else { container.innerHTML = '<span class="text-xs text-slate-400 pl-1">–ü–æ–±–ª–∏–∑—É –Ω–µ–º–∞—î –±—Ä–æ–≤–∞—Ä–µ–Ω—å</span>'; }
        } catch(e) { container.innerHTML = ''; }
    }

    // --- UPDATED Wiki (With Interaction) ---
    async function loadNearbyWiki(lat, lng) {
        const container = document.getElementById('wiki-container');
        container.innerHTML = '<span class="text-xs text-slate-400 pl-1">–®—É–∫–∞—é —Ü—ñ–∫–∞–≤—ñ –º—ñ—Å—Ü—è...</span>';
        try {
            const res = await fetch(`https://uk.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lng}&gsradius=10000&gslimit=3&format=json&origin=*`);
            const data = await res.json();
            const pages = data.query.geosearch;
            if(pages && pages.length > 0) {
                let html = '';
                pages.forEach(p => {
                    html += `
                    <div class="bg-white/60 p-3 rounded-2xl border border-white/60 hover:bg-white transition-colors flex justify-between items-center group">
                        <span class="text-xs font-bold text-slate-700 truncate flex-1 mr-2">${p.title}</span>
                        <div class="flex gap-2">
                            <button onclick="showOnMap(${p.lat}, ${p.lon})" class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center hover:bg-orange-500 hover:text-white transition-colors text-sm" title="–ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –º–∞–ø—ñ">üìç</button>
                            <a href="https://uk.wikipedia.org/?curid=${p.pageid}" target="_blank" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-800 hover:text-white transition-colors text-sm" title="–ß–∏—Ç–∞—Ç–∏">üìñ</a>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else { container.innerHTML = '<span class="text-xs text-slate-400">–ù—ñ—á–æ–≥–æ —Ü—ñ–∫–∞–≤–æ–≥–æ –ø–æ—Ä—É—á</span>'; }
        } catch(e) { container.innerHTML = ''; }
    }

    let stations = []; let sIdx = 0;
    const audio = document.getElementById('audio-player');
    const playBtn = document.getElementById('btn-play');
    const radioStatus = document.getElementById('radio-status');
    const radioLed = document.getElementById('radio-led');
    const viz = document.getElementById('visualizer');

    async function setupRadio(code) {
        document.getElementById('radio-title').innerText = "–ü–æ—à—É–∫...";
        radioStatus.innerText = "WAIT";
        radioLed.className = "w-2 h-2 rounded-full bg-slate-300";
        if(viz) viz.classList.remove('radio-playing');
        try {
            const res = await fetch(`https://de1.api.radio-browser.info/json/stations/bycountrycodeexact/${code}?limit=20&order=votes&reverse=true&hidebroken=true`);
            stations = await res.json();
            if(stations.length) { sIdx = 0; prepStation(0); } 
            else document.getElementById('radio-title').innerText = "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
        } catch(e) {}
    }
    function prepStation(idx) {
        const s = stations[idx];
        document.getElementById('radio-title').innerText = s.name.trim();
        document.getElementById('radio-status').innerText = "READY";
        audio.src = s.url_resolved;
        updatePlayBtn(false);
    }
    function updatePlayBtn(isPlaying) {
        const p = document.getElementById('icon-play'); const ps = document.getElementById('icon-pause');
        if(isPlaying) { p.classList.add('hidden'); ps.classList.remove('hidden'); } else { p.classList.remove('hidden'); ps.classList.add('hidden'); }
    }
    document.getElementById('btn-play').onclick = () => {
        if(audio.paused) {
            document.getElementById('radio-status').innerText = "LOADING...";
            audio.play().then(() => { 
                updatePlayBtn(true); document.getElementById('radio-status').innerText = "LIVE"; 
                if(viz) viz.classList.add('radio-playing');
            }).catch(() => { document.getElementById('radio-status').innerText = "ERROR"; document.getElementById('btn-next').click(); });
        } else {
            audio.pause(); updatePlayBtn(false); document.getElementById('radio-status').innerText = "PAUSED";
            if(viz) viz.classList.remove('radio-playing');
        }
    };
    document.getElementById('btn-next').onclick = () => { sIdx = (sIdx + 1) % stations.length; prepStation(sIdx); document.getElementById('btn-play').click(); };
    document.getElementById('btn-prev').onclick = () => { sIdx = (sIdx - 1 + stations.length) % stations.length; prepStation(sIdx); document.getElementById('btn-play').click(); };

    function getWInfo(code) {
        if (code === 0) return { text: "–Ø—Å–Ω–æ", icon: "‚òÄÔ∏è" };
        if (code <= 3) return { text: "–•–º–∞—Ä–Ω–æ", icon: "‚òÅÔ∏è" };
        if (code <= 67) return { text: "–î–æ—â", icon: "üåßÔ∏è" };
        if (code <= 77) return { text: "–°–Ω—ñ–≥", icon: "‚ùÑÔ∏è" };
        if (code <= 99) return { text: "–ì—Ä–æ–∑–∞", icon: "‚ö°" };
        return { text: "--", icon: "" };
    }
</script>
</body>
</html>
